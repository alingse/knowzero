# å­¦ä¹ è·¯çº¿å›¾å¢å¼ºè®¾è®¡æ–¹æ¡ˆ

## 1. ç°çŠ¶åˆ†æ

### å·²æœ‰èƒ½åŠ›
- `planner_agent` ç”Ÿæˆç»“æ„åŒ–è·¯çº¿å›¾ï¼ˆgoal + milestones + mermaidï¼‰
- åç«¯å®Œæ•´ CRUDï¼šRoadmap æ¨¡å‹ã€Schemaã€Serviceã€API
- å‰ç«¯åŸºç¡€æ¸²æŸ“ï¼šå‚ç›´æ—¶é—´çº¿ + å¯æŠ˜å é‡Œç¨‹ç¢‘å¡ç‰‡
- WebSocket å®æ—¶æ¨é€ + ä¼šè¯æ¢å¤

### æ ¸å¿ƒé—®é¢˜
| é—®é¢˜ | å½±å“ |
|------|------|
| Mermaid å›¾æ˜¾ç¤ºä¸ºåŸå§‹ä»£ç ï¼Œæœªæ¸²æŸ“ | å¯è§†åŒ–å½¢åŒè™šè®¾ |
| å‚ç›´æ—¶é—´çº¿ç¼ºä¹äº¤äº’ | çœ‹å®Œå°±å¿˜ï¼Œæ— æ³•é©±åŠ¨å­¦ä¹  |
| æ–‡æ¡£ä¸é‡Œç¨‹ç¢‘æ— å…³è” | å­¦äº†ä»€ä¹ˆã€å­¦åˆ°å“ªäº†ï¼Œä¸€æ— æ‰€çŸ¥ |
| æ— è¿›åº¦è¿½è¸ª | ç¼ºä¹æˆå°±æ„Ÿå’Œæ–¹å‘æ„Ÿ |
| è·¯çº¿å›¾æ˜¯"é™„å±å“"è€Œé"å¯¼èˆªå™¨" | ç”¨æˆ·ä¸ä¼šä¸»åŠ¨åˆ‡æ¢ tab å»çœ‹ |

### è®¾è®¡ç›®æ ‡
> å°†è·¯çº¿å›¾ä»"ç”Ÿæˆåå°±çœ‹ä¸€çœ¼çš„é™æ€å›¾"å‡çº§ä¸º"é©±åŠ¨æ•´ä¸ªå­¦ä¹ è¿‡ç¨‹çš„äº¤äº’å¼å¯¼èˆªå™¨"ã€‚

---

## 2. äº¤äº’è®¾è®¡

### 2.1 æ¨ªå‘é±¼éª¨å›¾ï¼ˆFishbone Timelineï¼‰

æ”¾å¼ƒ Mermaid æ¸²æŸ“ï¼Œæ”¹ç”¨è‡ªå®šä¹‰ React ç»„ä»¶å®ç°æ¨ªå‘é±¼éª¨å›¾ã€‚ç†ç”±ï¼š
- Mermaid æ¸²æŸ“éœ€è¦é¢å¤–ä¾èµ–ä¸”æ ·å¼ä¸å¯æ§
- è‡ªå®šä¹‰ç»„ä»¶å¯ä»¥å†…åµŒäº¤äº’ï¼ˆç‚¹å‡»ã€è¿›åº¦ã€åŠ¨ç”»ï¼‰
- æ¨ªå‘å¸ƒå±€ç¬¦åˆ"ä»å·¦åˆ°å³çš„å­¦ä¹ æ—…ç¨‹"å¿ƒæ™ºæ¨¡å‹

```
ASCII ç¤ºæ„å›¾ â€” æ¨ªå‘é±¼éª¨å›¾ï¼ˆFishbone Timelineï¼‰

                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  é˜¶æ®µ1       â”‚          â”‚  é˜¶æ®µ3       â”‚
                â”‚  åŸºç¡€è¯­æ³•    â”‚          â”‚  ç»„ä»¶é€šä¿¡    â”‚
                â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 67% â”‚          â”‚  â–‘â–‘â–‘â–‘â–‘â–‘  0% â”‚
                â”‚  ğŸ“„ 2 docs  â”‚          â”‚  ğŸ“„ 0 docs  â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                        â”‚
  â—‹ å­¦ä¹ ç›®æ ‡ â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â• â–¶ å®Œæˆ
  "æŒæ¡ React"         â”‚                        â”‚
                       â”‚                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                â”‚  é˜¶æ®µ2       â”‚          â”‚  é˜¶æ®µ4       â”‚
                â”‚  ç»„ä»¶ä¸Props â”‚          â”‚  Hooks      â”‚
                â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%â”‚          â”‚  â–‘â–‘â–‘â–‘â–‘â–‘  0% â”‚
                â”‚  ğŸ“„ 3 docs  â”‚  â† å½“å‰   â”‚  ğŸ“„ 0 docs  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹ï¼š
  â•â•â•â•â•â•  ä¸»å¹²ï¼ˆspineï¼‰ï¼Œå¸¦è¿›åº¦å¡«å……
  â”Œâ”€â”€â”€â”€â”  é‡Œç¨‹ç¢‘å¡ç‰‡ï¼Œäº¤æ›¿ä¸Šä¸‹æ’åˆ—
  â–ˆâ–ˆâ–ˆâ–ˆ    è¿›åº¦æ¡ï¼ˆå·²å®Œæˆéƒ¨åˆ†ï¼‰
  â–‘â–‘â–‘â–‘    è¿›åº¦æ¡ï¼ˆæœªå®Œæˆéƒ¨åˆ†ï¼‰
  ğŸ“„      å…³è”æ–‡æ¡£æ•°é‡
  â† å½“å‰   å½“å‰æ´»è·ƒé‡Œç¨‹ç¢‘é«˜äº®
```

### 2.2 é‡Œç¨‹ç¢‘å±•å¼€æ€

ç‚¹å‡»é‡Œç¨‹ç¢‘å¡ç‰‡åå±•å¼€ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼š

```
ASCII ç¤ºæ„å›¾ â€” é‡Œç¨‹ç¢‘å±•å¼€æ€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2: ç»„ä»¶ä¸Props                    âœ… å·²å®Œæˆ  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                 â”‚
â”‚  çŸ¥è¯†ç‚¹:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ å‡½æ•°ç»„ä»¶  â”‚ â”‚ Props    â”‚ â”‚ æ¡ä»¶æ¸²æŸ“  â”‚        â”‚
â”‚  â”‚    âœ…     â”‚ â”‚    âœ…    â”‚ â”‚    âœ…     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                 â”‚
â”‚  å…³è”æ–‡æ¡£:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ğŸ“„ React å‡½æ•°ç»„ä»¶å…¥é—¨        â†’ æŸ¥çœ‹  â”‚        â”‚
â”‚  â”‚ ğŸ“„ Props ä¸æ•°æ®æµ            â†’ æŸ¥çœ‹  â”‚        â”‚
â”‚  â”‚ ğŸ“„ æ¡ä»¶æ¸²æŸ“ä¸åˆ—è¡¨æ¸²æŸ“        â†’ æŸ¥çœ‹  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                 â”‚
â”‚  [ ğŸš€ å¼€å§‹å­¦ä¹ æœ¬é˜¶æ®µ ]   [ ğŸ“ æ ‡è®°ä¸ºå·²å®Œæˆ ]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 è·¯çº¿å›¾åœ¨é¡µé¢ä¸­çš„ä½ç½®

å½“å‰é—®é¢˜ï¼šè·¯çº¿å›¾è—åœ¨ tab åˆ‡æ¢é‡Œï¼Œç”¨æˆ·ä¸ä¼šä¸»åŠ¨å»çœ‹ã€‚

æ–°æ–¹æ¡ˆï¼šè·¯çº¿å›¾ä½œä¸ºå¯æŠ˜å çš„é¡¶éƒ¨å¯¼èˆªæ¡ï¼Œå§‹ç»ˆå¯è§ã€‚

```
ASCII ç¤ºæ„å›¾ â€” é¡µé¢å¸ƒå±€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sidebar  â”‚              Main Content                    â”‚
â”‚           â”‚                                              â”‚
â”‚  ğŸ“š æ–‡æ¡£   â”‚  â”Œâ”€â”€â”€â”€ Roadmap Bar (å¯æŠ˜å ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”œ åŸºç¡€è¯­æ³•â”‚  â”‚ â—â”â”â”â”â”â—â”â”â”â”â”â—‰â”â”â”â”â”â—‹â”â”â”â”â”â—‹  æŒæ¡React   â”‚  â”‚
â”‚  â”œ ç»„ä»¶    â”‚  â”‚ åŸºç¡€   ç»„ä»¶  é€šä¿¡   Hooks  é«˜çº§         â”‚  â”‚
â”‚  â”” ...    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                              â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€ Document View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚           â”‚  â”‚                                        â”‚  â”‚
â”‚           â”‚  â”‚  ğŸ“„ ç»„ä»¶é€šä¿¡ä¸çŠ¶æ€æå‡                    â”‚  â”‚
â”‚           â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚  â”‚
â”‚           â”‚  â”‚  å±äº: é˜¶æ®µ3 Â· ç»„ä»¶é€šä¿¡                  â”‚  â”‚
â”‚           â”‚  â”‚                                        â”‚  â”‚
â”‚           â”‚  â”‚  (æ–‡æ¡£å†…å®¹...)                           â”‚  â”‚
â”‚           â”‚  â”‚                                        â”‚  â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                              â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€ Chat Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚           â”‚  â”‚  ğŸ’¬ å¯¹è¯åŒºåŸŸ                             â”‚  â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Roadmap Bar è¯´æ˜ï¼š
  â—  å·²å®Œæˆé‡Œç¨‹ç¢‘ï¼ˆå®å¿ƒåœ† + ç»¿è‰²ï¼‰
  â—‰  å½“å‰æ´»è·ƒé‡Œç¨‹ç¢‘ï¼ˆå¤§åœ† + è„‰åŠ¨åŠ¨ç”»ï¼‰
  â—‹  æœªå¼€å§‹é‡Œç¨‹ç¢‘ï¼ˆç©ºå¿ƒåœ† + ç°è‰²ï¼‰
  â”â”  è¿æ¥çº¿ï¼ˆå·²å®Œæˆéƒ¨åˆ†é«˜äº®ï¼Œæœªå®Œæˆéƒ¨åˆ†ç°è‰²ï¼‰

ç‚¹å‡»ä»»æ„èŠ‚ç‚¹ â†’ å±•å¼€é‡Œç¨‹ç¢‘è¯¦æƒ…é¢æ¿ï¼ˆoverlayï¼‰
```

### 2.4 ç´§å‡‘æ¨¡å¼ vs å±•å¼€æ¨¡å¼

```
ç´§å‡‘æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œå§‹ç»ˆæ˜¾ç¤ºåœ¨æ–‡æ¡£ä¸Šæ–¹ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ â—â”â”â—â”â”â—‰â”â”â—‹â”â”â—‹  æŒæ¡React  3/5 å®Œæˆ  [å±•å¼€] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å±•å¼€æ¨¡å¼ï¼ˆç‚¹å‡»å±•å¼€ï¼Œæ˜¾ç¤ºå®Œæ•´é±¼éª¨å›¾ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ æŒæ¡ React                    3/5  [æ”¶èµ·]  â”‚
â”‚                                              â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚ åŸºç¡€è¯­æ³•â”‚      â”‚ ç»„ä»¶é€šä¿¡â”‚              â”‚
â”‚      â”‚  âœ… 100%â”‚      â”‚  â—‰ 30% â”‚              â”‚
â”‚  â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â–¶       â”‚
â”‚      â”‚        â”‚      â”‚        â”‚              â”‚
â”‚      â”‚ ç»„ä»¶   â”‚      â”‚ Hooks  â”‚              â”‚
â”‚      â”‚  âœ… 100%â”‚      â”‚  â—‹  0% â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ–‡æ¡£-é‡Œç¨‹ç¢‘å…³è”æœºåˆ¶

### 3.1 æ•°æ®æ¨¡å‹å˜æ›´

```
âš ï¸ æ³¨æ„ï¼šä»¥ä¸‹å­—æ®µéœ€è¦æ–°å¢åˆ° Document è¡¨ä¸­ï¼ˆå½“å‰æ¨¡å‹ä¸­å°šä¸å­˜åœ¨ï¼‰

Document è¡¨æ–°å¢å­—æ®µï¼š
  milestone_id: int | null    -- å…³è”çš„é‡Œç¨‹ç¢‘ IDï¼ˆroadmap.milestones[].idï¼‰
  roadmap_id: int | null      -- å…³è”çš„è·¯çº¿å›¾ IDï¼ˆFK â†’ roadmaps.idï¼‰

Roadmap.milestones JSON ç»“æ„å¢å¼ºï¼š
  {
    "id": 0,
    "title": "åŸºç¡€è¯­æ³•",
    "description": "...",
    "topics": ["å˜é‡", "ç±»å‹", "å‡½æ•°"],
    "status": "completed",        // NEW: "locked" | "active" | "completed"
    "documents": [1, 3, 5],       // NEW: å…³è”æ–‡æ¡£ ID åˆ—è¡¨ï¼ˆåŠ¨æ€è®¡ç®—ï¼Œä¸å­˜å‚¨ï¼‰
    "completed_topics": ["å˜é‡", "ç±»å‹"]  // NEW: å·²è¦†ç›–çš„çŸ¥è¯†ç‚¹
  }
```

### 3.2 è‡ªåŠ¨å…³è”æµç¨‹ï¼ˆç‹¬ç«‹ LLM åˆ†ç±»ï¼‰

å…³é”®è®¾è®¡å†³ç­–ï¼š**ä¸è®© content_agent è‡ªæ ‡æ³¨ milestone_id**ï¼Œè€Œæ˜¯åœ¨ `post_process` èŠ‚ç‚¹
ä¸­ç”¨ç‹¬ç«‹çš„ LLM è°ƒç”¨åšåˆ†ç±»ã€‚ç†ç”±ï¼š
- èŒè´£åˆ†ç¦»ï¼šcontent_agent ä¸“æ³¨å†…å®¹ç”Ÿæˆï¼Œåˆ†ç±»é€»è¾‘ç‹¬ç«‹å¯æµ‹è¯•
- å¯¹è‡ªç”±æ¢ç´¢åœºæ™¯ä¹Ÿç”Ÿæ•ˆï¼ˆç”¨æˆ·ç›´æ¥é—®é—®é¢˜ï¼Œä¸èµ° planner æµç¨‹ï¼‰
- ä¸éœ€è¦æ”¹ content_agent çš„ structured output

**å®ç°ä½ç½®**ï¼š`post_process` èŠ‚ç‚¹ï¼ˆLangGraph èŠ‚ç‚¹ï¼Œå½“å‰åœ¨ `backend/app/agent/nodes/content.py` ä¸­å®ç°ï¼‰

```python
# ========== ä¿®æ”¹å‰ï¼šå½“å‰ post_process_node ==========
entities, follow_ups = await asyncio.gather(
    _extract_entities_llm(content),
    _generate_follow_ups(content),
)

# ========== ä¿®æ”¹åï¼šæ·»åŠ é‡Œç¨‹ç¢‘åˆ†ç±» ==========
entities, follow_ups, milestone_id = await asyncio.gather(
    _extract_entities_llm(content),
    _generate_follow_ups(content),
    _classify_milestone(doc_topic, content[:500], roadmap),  # NEW
)

document["milestone_id"] = milestone_id
document["roadmap_id"] = roadmap.get("id") if milestone_id else None
```

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â”‚
    â–¼
content_agent ç”Ÿæˆæ–‡æ¡£ï¼ˆä¸æ„ŸçŸ¥ roadmapï¼‰
    â”‚
    â–¼
post_process èŠ‚ç‚¹ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
    â”‚
    â”œâ”€ æå–å®ä½“
    â”œâ”€ ç”Ÿæˆè·Ÿè¿›é—®é¢˜
    â””â”€ åˆ†ç±»æ–‡æ¡£åˆ°é‡Œç¨‹ç¢‘ï¼ˆNEWï¼‰
        â”‚
        â–¼
    _classify_milestone()
        â”‚
        â”œâ”€ è¾“å…¥ï¼šdoc.topic + doc.content[:500] + roadmap.milestones
        â”œâ”€ æ¨¡å‹ï¼šgpt-4o-miniï¼ˆä¾¿å®œã€å¿«ï¼‰
        â”œâ”€ è¾“å‡ºï¼šmilestone_id | None
        â””â”€ å†™å…¥ï¼šdoc.milestone_id, doc.roadmap_id
```

åˆ†ç±» prompt è®¾è®¡ï¼š

```python
CLASSIFY_PROMPT = """æ ¹æ®æ–‡æ¡£å†…å®¹ï¼Œåˆ¤æ–­å®ƒæœ€åŒ¹é…å­¦ä¹ è·¯çº¿å›¾çš„å“ªä¸ªé˜¶æ®µã€‚

æ–‡æ¡£æ ‡é¢˜: {doc_topic}
æ–‡æ¡£æ‘˜è¦: {doc_summary}

å­¦ä¹ è·¯çº¿å›¾:
{milestones_json}

è§„åˆ™ï¼š
1. è¿”å›æœ€åŒ¹é…çš„é˜¶æ®µ idï¼ˆæ•°å­—ï¼‰
2. å¦‚æœæ–‡æ¡£å†…å®¹è·¨å¤šä¸ªé˜¶æ®µï¼Œé€‰æ‹©æœ€ä¸»è¦çš„é‚£ä¸ª
3. å¦‚æœå®Œå…¨ä¸åŒ¹é…ä»»ä½•é˜¶æ®µï¼Œè¿”å› -1

åªè¿”å›ä¸€ä¸ªæ•°å­—ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""
```

è¿™ä¸ªè°ƒç”¨ä¸å®ä½“æå–ã€è·Ÿè¿›é—®é¢˜ç”Ÿæˆå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼ˆéƒ½åœ¨ post_process ä¸­ï¼‰ï¼Œ
ä¸å¢åŠ æ€»å»¶è¿Ÿã€‚

### 3.3 æ‰‹åŠ¨å…³è”

ç”¨æˆ·å¯ä»¥åœ¨æ–‡æ¡£è§†å›¾ä¸­æ‰‹åŠ¨è°ƒæ•´æ‰€å±é‡Œç¨‹ç¢‘ï¼š
- æ–‡æ¡£é¡¶éƒ¨æ˜¾ç¤º"å±äº: é˜¶æ®µX Â· æ ‡é¢˜"å¾½ç« 
- ç‚¹å‡»å¾½ç« å¼¹å‡ºä¸‹æ‹‰é€‰æ‹©å™¨ï¼Œå¯åˆ‡æ¢é‡Œç¨‹ç¢‘
- API: `PATCH /api/documents/{id}` æ›´æ–° `milestone_id`

---

## 4. è¿›åº¦è¿½è¸ªæœºåˆ¶

### 4.1 è¿›åº¦è®¡ç®—è§„åˆ™

```python
def calc_milestone_progress(milestone, documents):
    """è®¡ç®—å•ä¸ªé‡Œç¨‹ç¢‘çš„å®Œæˆè¿›åº¦"""
    if not milestone["topics"]:
        return 1.0 if documents else 0.0

    # æ–¹å¼1ï¼šåŸºäºæ–‡æ¡£è¦†ç›–çš„çŸ¥è¯†ç‚¹æ¯”ä¾‹
    covered_topics = set()
    for doc in documents:
        # æ–‡æ¡£çš„å®ä½“/å…³é”®è¯ä¸ milestone.topics çš„äº¤é›†
        covered_topics.update(
            t for t in milestone["topics"]
            if topic_matches(doc, t)
        )
    return len(covered_topics) / len(milestone["topics"])

def calc_milestone_status(milestone, progress):
    """æ ¹æ®è¿›åº¦ç¡®å®šçŠ¶æ€"""
    if progress >= 1.0:
        return "completed"
    elif progress > 0:
        return "active"
    else:
        # å‰ç½®é‡Œç¨‹ç¢‘å®Œæˆåè‡ªåŠ¨è§£é”
        return "active" if prev_completed else "locked"
```

### 4.2 è¿›åº¦ API

```
GET /api/roadmaps/{id}/progress
Response:
{
  "roadmap_id": 1,
  "overall_progress": 0.45,
  "milestones": [
    {
      "id": 0,
      "status": "completed",
      "progress": 1.0,
      "document_count": 3,
      "covered_topics": ["å˜é‡", "ç±»å‹", "å‡½æ•°"]
    },
    {
      "id": 1,
      "status": "active",
      "progress": 0.33,
      "document_count": 1,
      "covered_topics": ["å‡½æ•°ç»„ä»¶"]
    },
    ...
  ]
}
```

---

## 5. Agentic è·¯ç”±å†³ç­–ç³»ç»Ÿï¼ˆæ–¹æ¡ˆ Cï¼‰

### 5.1 è®¾è®¡æ¦‚è¿°

**æ ¸å¿ƒæ€æƒ³**ï¼šå¢å¼º `route_agent` èŠ‚ç‚¹ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªå…·å¤‡æ¨ç†èƒ½åŠ›çš„ Agentï¼Œè€Œä¸æ˜¯ç®€å•çš„è§„åˆ™åŒ¹é…å™¨ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ–¹æ¡ˆ Cï¼šå¢å¼º route_agent                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              ç”¨æˆ·è¾“å…¥
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           input_normalizer                                  â”‚
â”‚                        (æ ‡å‡†åŒ–è¾“å…¥æ ¼å¼)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            intent_agent                                     â”‚
â”‚                        â•â•â•â•â• è½»é‡ç‰ˆï¼šåªåšæ„å›¾åˆ†ç±» â•â•â•â•â•                        â”‚
â”‚                                                                             â”‚
â”‚  â€¢ èŒè´£ï¼šç†è§£ç”¨æˆ·æƒ³è¦ä»€ä¹ˆï¼ˆæ„å›¾åˆ†ç±»ï¼‰                                         â”‚
â”‚  â€¢ è¾“å…¥ï¼šuser_message                                                       â”‚
â”‚  â€¢ å¤„ç†ï¼šè§„åˆ™åŒ¹é… + LLM åˆ†ç±»ï¼ˆå¦‚éœ€è¦ï¼‰                                       â”‚
â”‚  â€¢ è¾“å‡ºï¼šintent: {intent_type, target, ...}                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   æ¡ä»¶è¾¹ (åŸºäº intent) â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚                        â”‚
   chitchat                navigate               [å…¶ä»–æ„å›¾]
        â”‚                        â”‚                        â”‚
        â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ chitchat_agentâ”‚    â”‚navigator_agentâ”‚    â”‚          route_agent  (å¢å¼ºç‰ˆ)         â”‚
â”‚               â”‚    â”‚               â”‚    â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â•â•â•â•â• Agentic è·¯ç”±å†³ç­– â•â•â•â•â•         â”‚
â”‚  â”‚é—²èŠå“åº” â”‚  â”‚    â”‚  â”‚æŸ¥æ‰¾æ–‡æ¡£ â”‚  â”‚    â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  è¾“å…¥:                                â”‚
â”‚               â”‚    â”‚               â”‚    â”‚  â”œâ”€ intent (æ¥è‡ª intent_agent)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”œâ”€ current_roadmap (ä¼šè¯çŠ¶æ€)         â”‚
                                              â”‚  â”œâ”€ user_level, learned_topics        â”‚
        â”‚                                      â”‚  â””â”€ current_doc_id                   â”‚
        â”‚                                      â”‚                                      â”‚
        â”‚                                      â”‚  å¤„ç†: æ··åˆç­–ç•¥                        â”‚
        â”‚                                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚                                      â”‚  â”‚ ã€å¿«é€Ÿè·¯å¾„ã€‘æ˜æ˜¾æƒ…å†µ â†’ è§„åˆ™     â”‚ â”‚
        â”‚                                      â”‚  â”‚ ã€æ™ºèƒ½è·¯å¾„ã€‘å¤æ‚æƒ…å†µ â†’ LLM æ¨ç†  â”‚ â”‚
        â”‚                                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚                                      â”‚                                      â”‚
        â”‚                                      â”‚  è¾“å‡º:                                â”‚
        â”‚                                      â”‚  â”œâ”€ action: "plan | generate_new..." â”‚
        â”‚                                      â”‚  â”œâ”€ mode: "modify | roadmap_learning" â”‚
        â”‚                                      â”‚  â”œâ”€ target: "å­¦ä¹ ç›®æ ‡"               â”‚
        â”‚                                      â”‚  â”œâ”€ reasoning: "æ¨ç†è¿‡ç¨‹"            â”‚
        â”‚                                      â”‚  â””â”€ confidence: 0.9                  â”‚
        â”‚                                      â”‚                                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚    æ¡ä»¶è¾¹ (åŸºäº routing_decision)      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                      â”‚                                     â”‚
        â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ planner_agent â”‚                    â”‚ content_agent â”‚
â”‚               â”‚                    â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ç”Ÿæˆ/    â”‚  â”‚                    â”‚  â”‚ç”Ÿæˆæ–‡æ¡£ â”‚  â”‚
â”‚  â”‚ä¿®æ”¹     â”‚  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚è·¯çº¿å›¾   â”‚  â”‚                    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
                                               â”‚
                                               â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ post_process  â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                              END
```

### 5.2 èŒè´£åˆ†å·¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          èŠ‚ç‚¹èŒè´£æ¸…æ™°åˆ†å·¥                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  intent_agent   â”‚â”€â”€â”€â†’â”‚  route_agent    â”‚â”€â”€â”€â†’â”‚  content_agent  â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚  planner_agent  â”‚
â”‚  "ç”¨æˆ·æƒ³è¦ä»€ä¹ˆï¼Ÿ" â”‚    â”‚  "æˆ‘ä»¬è¯¥æ€ä¹ˆåšï¼Ÿ" â”‚    â”‚  "æ‰§è¡Œä»»åŠ¡"     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚  â€¢ ç†è§£æ„å›¾      â”‚    â”‚  â€¢ åŸºäºä¸Šä¸‹æ–‡    â”‚    â”‚  â€¢ ç”Ÿæˆå†…å®¹     â”‚
â”‚  â€¢ æå–ç›®æ ‡      â”‚    â”‚  â€¢ å†³ç­–ä¸‹ä¸€æ­¥    â”‚    â”‚  â€¢ è§„åˆ’è·¯å¾„     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å®Œæ•´å®ç°ä»£ç 

```python
# backend/app/agent/nodes/route.py

"""Agentic Route Agent - åŸºäºå®Œæ•´ä¸Šä¸‹æ–‡çš„æ™ºèƒ½è·¯ç”±å†³ç­–."""

import json
import re
from typing import Any

from langchain_core.messages import HumanMessage, SystemMessage
from pydantic import BaseModel, Field

from app.agent.llm import get_llm
from app.agent.state import AgentState
from app.core.logging import get_logger

logger = get_logger(__name__)


# ============================================================================
# Pydantic æ¨¡å‹ï¼šç»“æ„åŒ–è¾“å‡º
# ============================================================================

class RouteDecision(BaseModel):
    """Routing decision output from LLM."""

    action: str = Field(
        description="Next action: generate_new | update_doc | navigate | plan"
    )
    mode: str = Field(
        description="Execution mode: standard | roadmap_learning | "
                   "roadmap_generate | roadmap_modify | explain_selection | ..."
    )
    target: str | None = Field(
        default=None,
        description="Learning target if applicable"
    )
    reasoning: str = Field(
        description="Explanation of why this decision was made"
    )
    confidence: float = Field(
        default=0.8,
        description="Decision confidence (0.0 - 1.0)"
    )


# ============================================================================
# å¿«é€Ÿè·¯å¾„ï¼šæ˜æ˜¾æƒ…å†µçš„è§„åˆ™åŒ¹é…
# ============================================================================

# æ˜æ˜¾çš„è·¯ç”±å†³ç­–è§„åˆ™ï¼ˆä¸éœ€è¦ LLMï¼‰
OBVIOUS_DECISIONS = {
    # chitchat - å·²åœ¨ intent_agent å¤„ç†
    # navigate - å·²åœ¨ intent_agent å¤„ç†

    # ç®€å•çš„æ–°ä¸»é¢˜ï¼Œæ²¡æœ‰ roadmap
    ("new_topic", False): {
        "action": "generate_new",
        "mode": "standard",
        "reasoning": "New topic without roadmap, generate standalone document"
    },

    # è·Ÿè¿›é—®é¢˜ï¼Œæœ‰å½“å‰æ–‡æ¡£
    ("follow_up", "has_current_doc"): {
        "action": "update_doc",
        "mode": "expand",
        "reasoning": "Follow-up on current document"
    },

    # è·Ÿè¿›é—®é¢˜ï¼Œæ²¡æœ‰å½“å‰æ–‡æ¡£
    ("follow_up", None): {
        "action": "generate_new",
        "mode": "standard",
        "reasoning": "Follow-up without current doc, create new"
    },

    # å¯¹æ¯”åˆ†æ
    ("comparison", None): {
        "action": "generate_new",
        "mode": "comparison",
        "reasoning": "Generate comparison document"
    },

    # ä¼˜åŒ–å†…å®¹ï¼ˆé€‰ä¸­æ–‡æœ¬è¯„è®ºï¼‰
    ("optimize_content", None): {
        "action": "generate_new",
        "mode": "explain_selection",
        "reasoning": "Generate new document to explain selected content"
    },
}


# ============================================================================
# ä¸»èŠ‚ç‚¹å‡½æ•°
# ============================================================================

async def route_agent_node(state: AgentState) -> AgentState:
    """Agentic routing: åŸºäºå®Œæ•´ä¸Šä¸‹æ–‡è‡ªä¸»å†³ç­–ã€‚

    èŒè´£ï¼š
    - è¾“å…¥ï¼šintentï¼ˆç”¨æˆ·æ„å›¾ï¼‰+ å®Œæ•´ä¼šè¯ä¸Šä¸‹æ–‡
    - å¤„ç†ï¼šæ··åˆç­–ç•¥ï¼ˆè§„åˆ™ + LLM æ¨ç†ï¼‰
    - è¾“å‡ºï¼šrouting_decisionï¼ˆä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼‰

    è®¾è®¡ç†å¿µï¼š
    - æ˜æ˜¾æƒ…å†µèµ°å¿«é€Ÿè·¯å¾„ï¼ˆè§„åˆ™åŒ¹é…ï¼Œ< 1msï¼‰
    - å¤æ‚æƒ…å†µèµ°æ™ºèƒ½è·¯å¾„ï¼ˆLLM æ¨ç†ï¼Œ~500msï¼‰
    - è¾“å‡º reasoning ä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–
    """
    intent = state.get("intent", {})
    intent_type = intent.get("intent_type", "question")
    current_roadmap = state.get("current_roadmap")
    current_doc_id = state.get("current_doc_id")

    logger.info(
        "Route Agent processing",
        intent_type=intent_type,
        has_roadmap=current_roadmap is not None,
        current_doc_id=current_doc_id,
    )

    # ========== å¿«é€Ÿè·¯å¾„ï¼šæ˜æ˜¾æƒ…å†µ ==========
    fast_decision = _try_fast_route(intent_type, current_doc_id, current_roadmap, state)
    if fast_decision:
        logger.info(
            "Fast route decision",
            action=fast_decision["action"],
            reasoning=fast_decision["reasoning"],
        )
        state["routing_decision"] = {
            **fast_decision,
            "method": "rule",
        }
        return state

    # ========== æ™ºèƒ½è·¯å¾„ï¼šLLM æ¨ç† ==========
    context = _build_decision_context(state)
    llm_decision = await _llm_route_decision(context, get_llm())

    logger.info(
        "LLM route decision",
        action=llm_decision["action"],
        mode=llm_decision["mode"],
        reasoning=llm_decision["reasoning"],
        confidence=llm_decision["confidence"],
    )

    state["routing_decision"] = {
        **llm_decision,
        "method": "llm",
    }
    return state


def _try_fast_route(
    intent_type: str,
    current_doc_id: int | None,
    current_roadmap: dict | None,
    state: AgentState
) -> dict | None:
    """å°è¯•å¿«é€Ÿè·¯ç”±å†³ç­–ï¼ˆè§„åˆ™åŒ¹é…ï¼‰ã€‚

    è¿”å›å†³ç­– dict å¦‚æœåŒ¹é…æˆåŠŸï¼Œå¦åˆ™è¿”å› Noneã€‚
    """
    # æ„å»º lookup key
    if intent_type == "follow_up":
        key = ("follow_up", "has_current_doc" if current_doc_id else None)
    elif intent_type in OBVIOUS_DECISIONS:
        key = (intent_type, None)
    else:
        return None

    decision = OBVIOUS_DECISIONS.get(key)
    if decision:
        result = decision.copy()
        # æ·»åŠ  target å¦‚æœå¯ç”¨
        intent = state.get("intent", {})
        if intent.get("target"):
            result["target"] = intent["target"]
        return result

    return None


def _build_decision_context(state: AgentState) -> dict[str, Any]:
    """æ„å»ºå®Œæ•´çš„å†³ç­–ä¸Šä¸‹æ–‡ã€‚

    è¿™æ˜¯ Agentic çš„å…³é”®ï¼šç»™ LLM æä¾›è¶³å¤Ÿçš„ä¿¡æ¯æ¥åšå†³ç­–ã€‚
    """
    current_roadmap = state.get("current_roadmap")

    context = {
        # ç”¨æˆ·è¾“å…¥
        "user_message": state.get("raw_message", ""),
        "detected_intent": state.get("intent", {}),
        "detected_target": state.get("intent", {}).get("target"),

        # ä¼šè¯çŠ¶æ€
        "has_roadmap": current_roadmap is not None,
        "current_roadmap_summary": _summarize_roadmap(current_roadmap),
        "current_doc_id": state.get("current_doc_id"),

        # ç”¨æˆ·ä¸Šä¸‹æ–‡
        "user_level": state.get("user_level", "beginner"),
        "learned_topics": state.get("learned_topics", []),
        "recent_docs": state.get("recent_docs", []),

        # è·¯çº¿å›¾è¿›åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
        "milestone_progress": _get_milestone_progress(state) if current_roadmap else None,
    }

    return context


def _summarize_roadmap(roadmap: dict | None) -> str:
    """ç”Ÿæˆè·¯çº¿å›¾çš„æ‘˜è¦ï¼Œä¾› LLM ç†è§£ã€‚"""
    if not roadmap:
        return "æ— "

    milestones = roadmap.get("milestones", [])
    if not milestones:
        return f"ã€Œ{roadmap.get('goal', '')}ã€ï¼Œæ— é˜¶æ®µ"

    milestone_summary = "; ".join([
        f"é˜¶æ®µ{m.get('id')}: {m.get('title')}"
        for m in milestones[:5]  # åªå–å‰5ä¸ª
    ])

    return f"ã€Œ{roadmap.get('goal', '')}ã€ï¼Œå…± {len(milestones)} ä¸ªé˜¶æ®µ: {milestone_summary}"


def _get_milestone_progress(state: AgentState) -> list[dict]:
    """è·å–å„é‡Œç¨‹ç¢‘çš„è¿›åº¦ï¼ˆå¦‚æœæœ‰ roadmapï¼‰ã€‚

    è¿™ä¸ªä¿¡æ¯å¯ä»¥å¸®åŠ© LLM åšæ›´æ™ºèƒ½çš„å†³ç­–ã€‚
    """
    # è¿™é‡Œå¯ä»¥è°ƒç”¨è¿›åº¦è®¡ç®—æœåŠ¡ï¼Œæˆ–ä»ç¼“å­˜ä¸­è·å–
    # ç®€åŒ–ç‰ˆï¼šè¿”å›ç©ºåˆ—è¡¨ï¼Œå®é™…å®ç°æ—¶è¡¥å……
    return []


# ============================================================================
# LLM æ™ºèƒ½å†³ç­–
# ============================================================================

async def _llm_route_decision(context: dict[str, Any], llm) -> dict[str, Any]:
    """ä½¿ç”¨ LLM è¿›è¡Œæ™ºèƒ½è·¯ç”±å†³ç­–ã€‚

    è¿™æ˜¯ Agentic çš„æ ¸å¿ƒï¼šLLM ä¸æ˜¯ç®€å•çš„åˆ†ç±»å™¨ï¼Œ
    è€Œæ˜¯åŸºäºå®Œæ•´ä¸Šä¸‹æ–‡çš„å†³ç­–è€…ã€‚
    """

    system_prompt = """ä½ æ˜¯ KnowZero å­¦ä¹ å¹³å°çš„è·¯ç”±å†³ç­– Agentã€‚

ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥å’Œä¼šè¯çŠ¶æ€ï¼Œå†³å®šä¸‹ä¸€æ­¥çš„è¡ŒåŠ¨ã€‚

**å¯ç”¨çš„è¡ŒåŠ¨**ï¼š
1. **generate_new** - ç”Ÿæˆæ–°çš„å­¦ä¹ æ–‡æ¡£
2. **update_doc** - æ›´æ–°/æ‰©å±•ç°æœ‰æ–‡æ¡£
3. **navigate** - å¯¼èˆªåˆ°ç°æœ‰æ–‡æ¡£
4. **plan** - ç”Ÿæˆ/ä¿®æ”¹å­¦ä¹ è·¯çº¿å›¾

**å¯ç”¨çš„æ¨¡å¼**ï¼š
- **standard**: æ ‡å‡†ç”Ÿæˆï¼ˆæ— è·¯çº¿å›¾ä¸Šä¸‹æ–‡ï¼‰
- **roadmap_learning**: åœ¨è·¯çº¿å›¾å†…å­¦ä¹ ï¼ˆç”Ÿæˆæ–‡æ¡£å¹¶è‡ªåŠ¨å…³è”åˆ°é‡Œç¨‹ç¢‘ï¼‰
- **roadmap_generate**: ç”Ÿæˆæ–°è·¯çº¿å›¾ï¼ˆé¦–æ¬¡ï¼‰
- **roadmap_modify**: ä¿®æ”¹ç°æœ‰è·¯çº¿å›¾

**å†³ç­–åŸåˆ™**ï¼š
1. ç”¨æˆ·é¦–æ¬¡è¡¨è¾¾ç³»ç»Ÿæ€§å­¦ä¹ éœ€æ±‚ï¼Œä¸”æ²¡æœ‰è·¯çº¿å›¾ â†’ roadmap_generate
2. ç”¨æˆ·å·²æœ‰è·¯çº¿å›¾ï¼Œä¸”è¡¨è¾¾è°ƒæ•´æ„å›¾ï¼ˆå¤ªç®€å•ã€å¤ªåŸºç¡€ã€è°ƒæ•´ç­‰ï¼‰â†’ roadmap_modify
3. ç”¨æˆ·å·²æœ‰è·¯çº¿å›¾ï¼Œé—®å…·ä½“é—®é¢˜ â†’ roadmap_learning
4. ç”¨æˆ·æ²¡æœ‰è·¯çº¿å›¾ï¼Œé—®å…·ä½“é—®é¢˜ â†’ standard
5. ç”¨æˆ·é€‰ä¸­æ–‡æœ¬å¹¶è¯„è®º â†’ explain_selection
6. ç”¨æˆ·æƒ³å¯¹æ¯”æ¦‚å¿µ â†’ comparison

è¿”å› JSON æ ¼å¼ï¼ŒåŒ…å« reasoning å­—æ®µè§£é‡Šä½ çš„å†³ç­–é€»è¾‘ã€‚"""

    user_prompt = _build_user_prompt(context)

    try:
        structured_llm = llm.with_structured_output(RouteDecision)
        result: RouteDecision = await structured_llm.ainvoke([
            SystemMessage(content=system_prompt),
            HumanMessage(content=user_prompt),
        ])

        return result.model_dump()

    except Exception as e:
        logger.warning("LLM routing failed, using fallback", error=str(e))
        # é™çº§åˆ°ç®€å•è§„åˆ™
        return _fallback_routing(context)


def _build_user_prompt(context: dict[str, Any]) -> str:
    """æ„å»º LLM çš„ç”¨æˆ·æç¤ºã€‚"""

    parts = [
        "**ç”¨æˆ·è¾“å…¥**ï¼š",
        context["user_message"],
        "",
        "**æ£€æµ‹åˆ°çš„æ„å›¾**ï¼š",
        f"- ç±»å‹: {context['detected_intent'].get('intent_type', 'unknown')}",
        f"- ç›®æ ‡: {context['detected_target'] or 'æ— '}",
        "",
        "**ä¼šè¯çŠ¶æ€**ï¼š",
        f"- ç”¨æˆ·æ°´å¹³: {context['user_level']}",
        f"- æ˜¯å¦æœ‰è·¯çº¿å›¾: {'æ˜¯' if context['has_roadmap'] else 'å¦'}",
        f"- å½“å‰è·¯çº¿å›¾: {context['current_roadmap_summary']}",
        f"- å½“å‰æ–‡æ¡£ID: {context['current_doc_id'] or 'æ— '}",
        f"- å·²å­¦ä¸»é¢˜: {', '.join(context['learned_topics'][-5:]) if context['learned_topics'] else 'æ— '}",
    ]

    # å¦‚æœæœ‰é‡Œç¨‹ç¢‘è¿›åº¦ï¼Œæ·»åŠ åˆ°ä¸Šä¸‹æ–‡
    if context.get("milestone_progress"):
        parts.append("")
        parts.append("**é‡Œç¨‹ç¢‘è¿›åº¦**ï¼š")
        for ms in context["milestone_progress"]:
            parts.append(f"- é˜¶æ®µ{ms['id']} ({ms['title']}): {ms['progress']:.0%}")

    parts.append("")
    parts.append("**è¯·å†³ç­–ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š")

    return "\n".join(parts)


def _fallback_routing(context: dict[str, Any]) -> dict[str, Any]:
    """é™çº§è·¯ç”±ç­–ç•¥ï¼šLLM å¤±è´¥æ—¶ä½¿ç”¨ç®€å•è§„åˆ™ã€‚"""

    intent_type = context["detected_intent"].get("intent_type", "question")
    has_roadmap = context["has_roadmap"]

    # ä¿å®ˆç­–ç•¥
    if intent_type == "plan" and not has_roadmap:
        return {
            "action": "plan",
            "mode": "roadmap_generate",
            "target": context["detected_target"],
            "reasoning": "Fallback: plan intent without roadmap",
            "confidence": 0.5,
        }

    return {
        "action": "generate_new",
        "mode": "roadmap_learning" if has_roadmap else "standard",
        "target": context["detected_target"],
        "reasoning": "Fallback: default to generate_new",
        "confidence": 0.5,
    }


# ============================================================================
# æ¡ä»¶è¾¹å‡½æ•°ï¼ˆç”¨äº graph.pyï¼‰
# ============================================================================

def route_by_intent(state: AgentState) -> str:
    """Route to next node based on intent.

    Returns node name for conditional edge.
    """
    intent = state.get("intent", {})
    intent_type = intent.get("intent_type", "question")

    if intent_type == "chitchat":
        return "chitchat_agent"
    if intent_type == "navigate":
        return "navigator_agent"

    # All other intents go through route agent
    return "route_agent"


def route_by_decision(state: AgentState) -> str:
    """Route based on routing decision.

    Returns node name for conditional edge.
    """
    decision = state.get("routing_decision", {})
    action = decision.get("action", "generate_new")

    if action == "navigate":
        return "navigator_agent"
    if action == "plan":
        return "planner_agent"
    return "content_agent"
```

### 5.4 çŠ¶æ€å­—æ®µæ‰©å±•

```python
# backend/app/agent/state.py

from typing import Annotated

class AgentState(TypedDict):
    # ... ç°æœ‰å­—æ®µ ...

    # NEW: è·¯çº¿å›¾ç›¸å…³ï¼ˆéµå¾ªç°æœ‰ä»£ç é£æ ¼ï¼Œä½¿ç”¨ Annotatedï¼‰
    current_roadmap: Annotated[dict | None, "å½“å‰æ´»è·ƒè·¯çº¿å›¾"]
    roadmap_modified: Annotated[bool, "è·¯çº¿å›¾æ˜¯å¦è¢«ä¿®æ”¹è¿‡"]
    roadmap_only: Annotated[bool, "æ˜¯å¦ä»…ç”Ÿæˆè·¯çº¿å›¾è€Œä¸ç”Ÿæˆæ–‡æ¡£"]  # ç”¨äºæ¡ä»¶è·¯ç”±
```

### 5.5 å†³ç­–ç¤ºä¾‹

**åœºæ™¯ 1ï¼šé¦–æ¬¡å­¦ä¹ ï¼Œç”Ÿæˆè·¯çº¿å›¾**
```
è¾“å…¥:
  user_message: "æˆ‘æƒ³ç³»ç»Ÿå­¦ä¹  React"
  has_roadmap: False
  user_level: "beginner"

LLM æ¨ç†:
  Thought: ç”¨æˆ·æƒ³"ç³»ç»Ÿå­¦ä¹ "Reactï¼Œä¸”æ²¡æœ‰è·¯çº¿å›¾ï¼Œ
           åº”è¯¥å…ˆç”Ÿæˆå­¦ä¹ è·¯çº¿å›¾
  Decision: action=plan, mode=roadmap_generate
  Reasoning: ç”¨æˆ·é¦–æ¬¡è¡¨è¾¾ç³»ç»Ÿæ€§å­¦ä¹ éœ€æ±‚ä¸”æ— è·¯çº¿å›¾ï¼Œç”Ÿæˆæ–°è·¯çº¿å›¾

è¾“å‡º:
  {
    "action": "plan",
    "mode": "roadmap_generate",
    "target": "React",
    "reasoning": "ç”¨æˆ·é¦–æ¬¡è¡¨è¾¾ç³»ç»Ÿæ€§å­¦ä¹ éœ€æ±‚ä¸”æ— è·¯çº¿å›¾ï¼Œç”Ÿæˆæ–°è·¯çº¿å›¾",
    "confidence": 0.95
  }
```

**åœºæ™¯ 2ï¼šå·²æœ‰è·¯çº¿å›¾ï¼Œç»§ç»­å­¦ä¹ **
```
è¾“å…¥:
  user_message: "ä»€ä¹ˆæ˜¯ useStateï¼Ÿ"
  has_roadmap: True
  roadmap: "æŒæ¡React, å…±4ä¸ªé˜¶æ®µ..."
  user_level: "intermediate"

LLM æ¨ç†:
  Thought: ç”¨æˆ·å·²æœ‰ React è·¯çº¿å›¾ï¼Œé—®çš„æ˜¯ useStateï¼Œ
           è¿™æ˜¯ Hooks ç›¸å…³çš„å†…å®¹ï¼Œåº”è¯¥å±äºè·¯çº¿å›¾ä¸­çš„æŸä¸ªé˜¶æ®µ
  Decision: action=generate_new, mode=roadmap_learning
  Reasoning: ç”¨æˆ·æœ‰è·¯çº¿å›¾ï¼Œé—®é¢˜å†…å®¹å±äºè·¯çº¿å›¾èŒƒç•´ï¼Œåœ¨è·¯çº¿å›¾å†…å­¦ä¹ 

è¾“å‡º:
  {
    "action": "generate_new",
    "mode": "roadmap_learning",
    "target": "useState",
    "reasoning": "ç”¨æˆ·æœ‰è·¯çº¿å›¾ï¼Œé—®é¢˜å†…å®¹å±äºè·¯çº¿å›¾èŒƒç•´ï¼Œåœ¨è·¯çº¿å›¾å†…å­¦ä¹ ",
    "confidence": 0.9
  }
```

**åœºæ™¯ 3ï¼šè°ƒæ•´è·¯çº¿å›¾**
```
è¾“å…¥:
  user_message: "å¤ªç®€å•äº†ï¼Œè·³è¿‡åŸºç¡€"
  has_roadmap: True
  roadmap: "æŒæ¡React, å…±4ä¸ªé˜¶æ®µ..."
  user_level: "intermediate"

LLM æ¨ç†:
  Thought: ç”¨æˆ·æœ‰è·¯çº¿å›¾ï¼Œè¯´"å¤ªç®€å•äº†"ã€"è·³è¿‡åŸºç¡€"ï¼Œ
           ç»“åˆç”¨æˆ·æ˜¯ä¸­çº§æ°´å¹³ï¼Œåº”è¯¥è°ƒæ•´è·¯çº¿å›¾éš¾åº¦æˆ–è·³è¿‡åŸºç¡€é˜¶æ®µ
  Decision: action=plan, mode=roadmap_modify
  Reasoning: ç”¨æˆ·æœ‰è·¯çº¿å›¾ä¸”åé¦ˆå†…å®¹ç®€å•ï¼Œåº”è¯¥è°ƒæ•´è·¯çº¿å›¾éš¾åº¦æˆ–è·³è¿‡åŸºç¡€é˜¶æ®µ

è¾“å‡º:
  {
    "action": "plan",
    "mode": "roadmap_modify",
    "target": "React",
    "reasoning": "ç”¨æˆ·æœ‰è·¯çº¿å›¾ä¸”åé¦ˆå†…å®¹ç®€å•ï¼Œåº”è¯¥è°ƒæ•´è·¯çº¿å›¾éš¾åº¦æˆ–è·³è¿‡åŸºç¡€é˜¶æ®µ",
    "confidence": 0.85
  }
```

### 5.6 æ€§èƒ½ä¼˜åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ€§èƒ½åˆ†æ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯                          å¤„ç†æ–¹å¼      è€—æ—¶        æˆæœ¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"ä½ å¥½"                       è§„åˆ™åŒ¹é…      < 1ms       0 token
"ä»€ä¹ˆæ˜¯ useState"ï¼ˆæœ‰ roadmapï¼‰ LLM å†³ç­–     ~500ms     ~100 token
"å¤ªç®€å•äº†"                    LLM å†³ç­–     ~500ms     ~100 token
"æˆ‘æƒ³å­¦ React"ï¼ˆæ—  roadmapï¼‰   è§„åˆ™åŒ¹é…      < 1ms       0 token
"å¯¹æ¯” useState å’Œ useEffect"  è§„åˆ™åŒ¹é…      < 1ms       0 token

ä¼°ç®—ï¼š
- çº¦ 60-70% çš„è¯·æ±‚èµ°å¿«é€Ÿè·¯å¾„ï¼ˆè§„åˆ™åŒ¹é…ï¼‰
- çº¦ 30-40% çš„è¯·æ±‚èµ°æ™ºèƒ½è·¯å¾„ï¼ˆLLM å†³ç­–ï¼‰
- å¹³å‡å»¶è¿Ÿï¼šçº¦ 150-200msï¼ˆå« LLM è°ƒç”¨çš„è¯·æ±‚ï¼‰
- token æ¶ˆè€—ï¼šçº¦ 30-40 token/è¯·æ±‚ï¼ˆå¹³å‡ï¼‰
```

---

## 6. å…¸å‹ç”¨æˆ·äº¤äº’æµç¨‹

### Flow 1: é¦–æ¬¡ç”Ÿæˆè·¯çº¿å›¾

**å†³ç­–æµç¨‹ï¼ˆAgentic æ–¹å¼ï¼‰**ï¼š

```
ç”¨æˆ·é¦–æ¬¡è¾“å…¥å­¦ä¹ ä¸»é¢˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        intent_agent                          â”‚
â”‚                      (æ„å›¾åˆ†ç±»: plan)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       route_agent                            â”‚
â”‚                    â•â•â•â•â• Agentic å†³ç­– â•â•â•â•â•                    â”‚
â”‚                                                             â”‚
â”‚  ä¸Šä¸‹æ–‡:                                                    â”‚
â”‚  â”œâ”€ intent: {intent_type: "plan", target: "React"}         â”‚
â”‚  â”œâ”€ has_roadmap: false                                      â”‚
â”‚  â”œâ”€ user_message: "æˆ‘æƒ³ç³»ç»Ÿå­¦ä¹  React"                      â”‚
â”‚  â””â”€ user_level: "beginner"                                  â”‚
â”‚                                                             â”‚
â”‚  LLM æ¨ç†:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·æƒ³"ç³»ç»Ÿå­¦ä¹ "Reactï¼Œä¸”æ²¡æœ‰è·¯çº¿å›¾ï¼Œ                   â”‚  â”‚
â”‚  â”‚ åº”è¯¥å…ˆç”Ÿæˆå­¦ä¹ è·¯çº¿å›¾                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  å†³ç­–:                                                       â”‚
â”‚  â””â”€ action: "plan", mode: "roadmap_generate"               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      planner_agent                           â”‚
â”‚                        (ç”Ÿæˆè·¯çº¿å›¾)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      content_agent                           â”‚
â”‚                 (ç”Ÿæˆç¬¬ä¸€ç¯‡æ–‡æ¡£ - é˜¶æ®µ1)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      post_process                            â”‚
â”‚           (æå–å®ä½“ + ç”Ÿæˆè·Ÿè¿›é—®é¢˜ + å…³è”åˆ°é˜¶æ®µ1)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                            END
```

**å®é™…äº¤äº’æµç¨‹**ï¼š

```
ç”¨æˆ·: "æˆ‘æƒ³ç³»ç»Ÿå­¦ä¹  React"

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ’¬ Chat                                     â”‚
  â”‚ ç”¨æˆ·: æˆ‘æƒ³ç³»ç»Ÿå­¦ä¹  React                      â”‚
  â”‚ AI: æ­£åœ¨è§„åˆ’å­¦ä¹ è·¯å¾„...                       â”‚
  â”‚ AI: å·²ä¸ºä½ ç”Ÿæˆ React å­¦ä¹ è·¯çº¿å›¾ï¼Œå…±5ä¸ªé˜¶æ®µ     â”‚
  â”‚ AI: è®©æˆ‘ä»¬ä»ã€ŒåŸºç¡€è¯­æ³•ã€å¼€å§‹å­¦ä¹ ...           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â†’ Roadmap Bar å‡ºç°åœ¨æ–‡æ¡£åŒºä¸Šæ–¹ï¼ˆç´§å‡‘æ¨¡å¼ï¼‰
  â†’ è‡ªåŠ¨å±•å¼€ä¸ºå®Œæ•´é±¼éª¨å›¾ï¼ˆé¦–æ¬¡å±•ç¤ºï¼‰
  â†’ é˜¶æ®µ1 è‡ªåŠ¨æ¿€æ´»ï¼ŒAgent å¼€å§‹ç”Ÿæˆç¬¬ä¸€ç¯‡æ–‡æ¡£
  â†’ æ–‡æ¡£ç”Ÿæˆå®Œæˆï¼Œè‡ªåŠ¨å…³è”åˆ°é˜¶æ®µ1
  â†’ é˜¶æ®µ1 è¿›åº¦æ›´æ–°ä¸º 33%ï¼ˆå‡è®¾3ä¸ªtopicè¦†ç›–äº†1ä¸ªï¼‰
```

### Flow 2: æŒ‰è·¯çº¿å›¾å­¦ä¹ 

**å†³ç­–æµç¨‹ï¼ˆå·²æœ‰è·¯çº¿å›¾ï¼‰**ï¼š

```
ç”¨æˆ·åœ¨è·¯çº¿å›¾å†…ç»§ç»­å­¦ä¹ 
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        intent_agent                          â”‚
â”‚                    (æ„å›¾åˆ†ç±»: new_topic)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       route_agent                            â”‚
â”‚                    â•â•â•â•â• Agentic å†³ç­– â•â•â•â•â•                    â”‚
â”‚                                                             â”‚
â”‚  ä¸Šä¸‹æ–‡:                                                    â”‚
â”‚  â”œâ”€ intent: {intent_type: "new_topic", target: "useState"}  â”‚
â”‚  â”œâ”€ has_roadmap: true                                       â”‚
â”‚  â”œâ”€ roadmap: "æŒæ¡React, å…±4ä¸ªé˜¶æ®µ..."                      â”‚
â”‚  â””â”€ user_message: "ä»€ä¹ˆæ˜¯ useStateï¼Ÿ"                       â”‚
â”‚                                                             â”‚
â”‚  LLM æ¨ç†:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·æœ‰ React è·¯çº¿å›¾ï¼Œé—® useStateï¼Œè¿™æ˜¯ Hooks ç›¸å…³çš„   â”‚  â”‚
â”‚  â”‚ å†…å®¹ï¼Œåº”è¯¥å±äºè·¯çº¿å›¾ä¸­çš„æŸä¸ªé˜¶æ®µï¼Œåœ¨è·¯çº¿å›¾å†…å­¦ä¹        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  å†³ç­–:                                                       â”‚
â”‚  â””â”€ action: "generate_new", mode: "roadmap_learning"        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      content_agent                           â”‚
â”‚                   (ç”Ÿæˆ useState æ–‡æ¡£)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      post_process                            â”‚
â”‚   (æå–å®ä½“ + ç”Ÿæˆè·Ÿè¿›é—®é¢˜ + è‡ªåŠ¨å…³è”åˆ°å¯¹åº”é‡Œç¨‹ç¢‘)            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ LLM åˆ†ç±»: useState å±äº "é˜¶æ®µ3: Hooks"              â”‚    â”‚
â”‚  â”‚ document.milestone_id = 3                           â”‚    â”‚
â”‚  â”‚ document.roadmap_id = 1                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                            END
```

**å®é™…äº¤äº’æµç¨‹**ï¼š
ç”¨æˆ·ç‚¹å‡» Roadmap Bar ä¸Šçš„ "é˜¶æ®µ2: ç»„ä»¶ä¸Props"

  â†’ é‡Œç¨‹ç¢‘è¯¦æƒ…é¢æ¿å±•å¼€
  â†’ æ˜¾ç¤º3ä¸ªçŸ¥è¯†ç‚¹: å‡½æ•°ç»„ä»¶ã€Propsã€æ¡ä»¶æ¸²æŸ“
  â†’ ç”¨æˆ·ç‚¹å‡» [ğŸš€ å¼€å§‹å­¦ä¹ æœ¬é˜¶æ®µ]
  â†’ Agent æ”¶åˆ°è¯·æ±‚ï¼Œç”Ÿæˆ"React å‡½æ•°ç»„ä»¶"æ–‡æ¡£
  â†’ æ–‡æ¡£è‡ªåŠ¨å…³è”åˆ°é˜¶æ®µ2
  â†’ é˜¶æ®µ2 è¿›åº¦ä» 0% â†’ 33%
  â†’ æ–‡æ¡£åº•éƒ¨è·Ÿè¿›é—®é¢˜å¼•å¯¼åˆ°ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹

ç”¨æˆ·ç»§ç»­å­¦ä¹ ï¼Œç‚¹å‡»è·Ÿè¿›é—®é¢˜æˆ–æ‰‹åŠ¨è¯·æ±‚ä¸‹ä¸€ä¸ª topic

  â†’ æ¯ç”Ÿæˆä¸€ç¯‡æ–‡æ¡£ï¼Œè¿›åº¦è‡ªåŠ¨æ›´æ–°
  â†’ é˜¶æ®µ2 æ‰€æœ‰ topic è¦†ç›–åï¼ŒçŠ¶æ€å˜ä¸º âœ… completed
  â†’ é˜¶æ®µ3 è‡ªåŠ¨è§£é”ï¼ˆä» locked â†’ activeï¼‰
  â†’ Roadmap Bar è¿›åº¦æ¡å‰è¿›
```

### Flow 3: ä¿®æ”¹è·¯çº¿å›¾

**å†³ç­–æµç¨‹ï¼ˆAgentic æ–¹å¼ï¼‰**ï¼š

```
ç”¨æˆ·è¡¨è¾¾è°ƒæ•´è·¯çº¿å›¾çš„æ„å›¾
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        intent_agent                          â”‚
â”‚                  (æ„å›¾åˆ†ç±»: è¯†åˆ«ä¸º plan æˆ–ç›¸å…³)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       route_agent                            â”‚
â”‚                    â•â•â•â•â• Agentic å†³ç­– â•â•â•â•â•                    â”‚
â”‚                                                             â”‚
â”‚  ä¸Šä¸‹æ–‡:                                                    â”‚
â”‚  â”œâ”€ has_roadmap: true                                       â”‚
â”‚  â”œâ”€ roadmap: "æŒæ¡React, å…±4ä¸ªé˜¶æ®µ..."                      â”‚
â”‚  â”œâ”€ user_message: "å¤ªç®€å•äº†ï¼Œè·³è¿‡åŸºç¡€"                      â”‚
â”‚  â””â”€ user_level: "intermediate"                              â”‚
â”‚                                                             â”‚
â”‚  LLM æ¨ç†:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·æœ‰è·¯çº¿å›¾ï¼Œè¯´"å¤ªç®€å•äº†"ã€"è·³è¿‡åŸºç¡€"ï¼Œ               â”‚  â”‚
â”‚  â”‚ ç»“åˆç”¨æˆ·æ˜¯ä¸­çº§æ°´å¹³ï¼Œåº”è¯¥è°ƒæ•´è·¯çº¿å›¾æˆ–è·³è¿‡åŸºç¡€é˜¶æ®µ       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  å†³ç­–:                                                       â”‚
â”‚  â””â”€ action: "plan", mode: "roadmap_modify"                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      planner_agent                           â”‚
â”‚                   (ä¿®æ”¹æ¨¡å¼: è°ƒæ•´è·¯çº¿å›¾)                      â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 1. è·å–å½“å‰è·¯çº¿å›¾                                    â”‚    â”‚
â”‚  â”‚ 2. æ ¹æ®ç”¨æˆ·è¦æ±‚è°ƒæ•´ï¼ˆè·³è¿‡åŸºç¡€ã€å‡çº§éš¾åº¦ç­‰ï¼‰           â”‚    â”‚
â”‚  â”‚ 3. version += 1                                       â”‚    â”‚
â”‚  â”‚ 4. è®¾ç½® roadmap_only = Trueï¼ˆä¸ç”Ÿæˆæ–‡æ¡£ï¼‰             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒæ­¥é‡æ˜ å°„æ–‡æ¡£                            â”‚
â”‚   (_remap_documents_after_modify)                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ å·²æœ‰æ–‡æ¡£å°è¯•é‡æ–°å…³è”åˆ°æ–°é‡Œç¨‹ç¢‘                     â”‚    â”‚
â”‚  â”‚ â€¢ æ— æ³•å…³è”çš„æ ‡è®°ä¸ºå­¤å„¿ï¼ˆä½†ä¿ç•™å†…å®¹ï¼‰                 â”‚    â”‚
â”‚  â”‚ â€¢ è¿”å›é‡æ˜ å°„ç»“æœ                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                            END
                    (è¿”å›æ–°è·¯çº¿å›¾ç»™ç”¨æˆ·)
```

### Flow 4: è‡ªç”±æ¢ç´¢ + è·¯çº¿å›¾åŒæ­¥

```
ç”¨æˆ·ä¸æŒ‰é¡ºåºï¼Œç›´æ¥é—®: "React Hooks æ€ä¹ˆç”¨ï¼Ÿ"

  â†’ Agent è¯†åˆ«è¿™å±äºé˜¶æ®µ4çš„å†…å®¹
  â†’ ç”Ÿæˆæ–‡æ¡£ï¼Œè‡ªåŠ¨å…³è”åˆ°é˜¶æ®µ4
  â†’ é˜¶æ®µ4 è™½ç„¶å‰ç½®æœªå®Œæˆï¼Œä½†è¿›åº¦å¼€å§‹ç´¯ç§¯
  â†’ Roadmap Bar ä¸Šé˜¶æ®µ4 æ˜¾ç¤ºéƒ¨åˆ†è¿›åº¦ï¼ˆè·³è·ƒå­¦ä¹ å¯è§†åŒ–ï¼‰
  â†’ ä¸å¼ºåˆ¶é¡ºåºï¼Œä½†è§†è§‰ä¸Šæç¤º"å»ºè®®å…ˆå®Œæˆå‰ç½®é˜¶æ®µ"
```

### Flow 5: ä»æ–‡æ¡£å›åˆ°è·¯çº¿å›¾

```
ç”¨æˆ·æ­£åœ¨é˜…è¯»ä¸€ç¯‡æ–‡æ¡£

  â†’ æ–‡æ¡£é¡¶éƒ¨æ˜¾ç¤º: "ğŸ“ é˜¶æ®µ2 Â· ç»„ä»¶ä¸Props"
  â†’ ç‚¹å‡»è¯¥å¾½ç«  â†’ Roadmap Bar å±•å¼€ï¼Œé«˜äº®é˜¶æ®µ2
  â†’ å¯ä»¥çœ‹åˆ°é˜¶æ®µ2çš„å…¶ä»–æ–‡æ¡£å’Œæœªè¦†ç›–çš„çŸ¥è¯†ç‚¹
  â†’ ç‚¹å‡»æœªè¦†ç›–çš„çŸ¥è¯†ç‚¹ â†’ é€šè¿‡ API è§¦å‘ Agent ç”Ÿæˆå¯¹åº”æ–‡æ¡£

API è°ƒç”¨:
POST /api/sessions/{session_id}/chat
{
  "message": "å­¦ä¹ ã€Œå‡½æ•°ç»„ä»¶ã€",  # ç”¨æˆ·ç‚¹å‡»çš„çŸ¥è¯†ç‚¹
  "input_source": "roadmap_topic",
  "roadmap_id": 1,
  "milestone_id": 2,
  "target_topic": "å‡½æ•°ç»„ä»¶"  # æ˜ç¡®çš„ç›®æ ‡ä¸»é¢˜
}

â†’ Agent æ”¶åˆ°è¯·æ±‚ï¼Œç”Ÿæˆæ–‡æ¡£å¹¶è‡ªåŠ¨å…³è”åˆ°é˜¶æ®µ2
â†’ é˜¶æ®µ2 è¿›åº¦æ›´æ–°
```

```
ç”¨æˆ·æ­£åœ¨é˜…è¯»ä¸€ç¯‡æ–‡æ¡£

  â†’ æ–‡æ¡£é¡¶éƒ¨æ˜¾ç¤º: "ğŸ“ é˜¶æ®µ2 Â· ç»„ä»¶ä¸Props"
  â†’ ç‚¹å‡»è¯¥å¾½ç«  â†’ Roadmap Bar å±•å¼€ï¼Œé«˜äº®é˜¶æ®µ2
  â†’ å¯ä»¥çœ‹åˆ°é˜¶æ®µ2çš„å…¶ä»–æ–‡æ¡£å’Œæœªè¦†ç›–çš„çŸ¥è¯†ç‚¹
  â†’ ç‚¹å‡»æœªè¦†ç›–çš„çŸ¥è¯†ç‚¹ â†’ è§¦å‘ Agent ç”Ÿæˆå¯¹åº”æ–‡æ¡£
```

---

## 7. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 7.1 åç«¯å˜æ›´

| å˜æ›´ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| Document æ¨¡å‹åŠ å­—æ®µ | `models/document.py` | æ–°å¢ `roadmap_id`, `milestone_id` |
| DB è¿ç§» | `alembic/versions/` | æ–°å¢è¿ç§»è„šæœ¬ |
| æ–‡æ¡£å…³è”æœåŠ¡ | `services/document_milestone_service.py` | è‡ªåŠ¨/æ‰‹åŠ¨å…³è”é€»è¾‘ |
| è¿›åº¦è®¡ç®— | `services/roadmap_service.py` | æ–°å¢ `get_progress()` |
| è¿›åº¦ API | `api/routes/roadmaps.py` | æ–°å¢ `GET /{id}/progress` |
| é‡Œç¨‹ç¢‘å­¦ä¹  API | `api/routes/roadmaps.py` | æ–°å¢ `POST /{id}/milestones/{mid}/start` |
| Agent ä¸Šä¸‹æ–‡æ³¨å…¥ | `agent/nodes/content.py` | prompt æ³¨å…¥å½“å‰ roadmap + milestone |
| è‡ªåŠ¨å…³è” | `agent/nodes/post_process.py` | æ–‡æ¡£ç”Ÿæˆåè‡ªåŠ¨å…³è”é‡Œç¨‹ç¢‘ |

### 7.2 å‰ç«¯å˜æ›´

| å˜æ›´ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| é±¼éª¨å›¾ç»„ä»¶ | `components/RoadmapView/FishboneTimeline.tsx` | æ¨ªå‘é±¼éª¨å›¾ä¸»ç»„ä»¶ |
| é‡Œç¨‹ç¢‘èŠ‚ç‚¹ | `components/RoadmapView/MilestoneNode.tsx` | å•ä¸ªé‡Œç¨‹ç¢‘èŠ‚ç‚¹ï¼ˆå«è¿›åº¦ç¯ï¼‰ |
| é‡Œç¨‹ç¢‘è¯¦æƒ… | `components/RoadmapView/MilestoneDetail.tsx` | å±•å¼€åçš„è¯¦æƒ…é¢æ¿ |
| ç´§å‡‘å¯¼èˆªæ¡ | `components/RoadmapView/RoadmapBar.tsx` | é¡¶éƒ¨ç´§å‡‘æ¨¡å¼å¯¼èˆªæ¡ |
| è¿›åº¦ç¯ | `components/RoadmapView/ProgressRing.tsx` | SVG åœ†ç¯è¿›åº¦æŒ‡ç¤ºå™¨ |
| æ–‡æ¡£é‡Œç¨‹ç¢‘å¾½ç«  | `components/DocumentView/MilestoneBadge.tsx` | æ–‡æ¡£é¡¶éƒ¨çš„é‡Œç¨‹ç¢‘æ ‡ç­¾ |
| é¡µé¢å¸ƒå±€æ”¹é€  | `pages/SessionPage.tsx` | é›†æˆ RoadmapBarï¼Œæ›¿æ¢ tab åˆ‡æ¢ |
| Store å¢å¼º | `stores/sessionStore.ts` | æ–°å¢ milestoneProgress çŠ¶æ€ |
| API å®¢æˆ·ç«¯ | `api/client.ts` | æ–°å¢ progressã€milestone start æ¥å£ |

### 7.3 é±¼éª¨å›¾ç»„ä»¶æ ¸å¿ƒå®ç°æ€è·¯

```
FishboneTimeline ç»„ä»¶ç»“æ„ï¼š

<div className="fishbone-container overflow-x-auto">
  <svg viewBox="0 0 {width} {height}">
    {/* ä¸»å¹²çº¿ï¼ˆspineï¼‰ */}
    <line class="spine" x1="0" y1="center" x2="100%" y2="center" />
    <line class="spine-progress" x1="0" y1="center" x2="{progress}%" y2="center" />

    {/* é‡Œç¨‹ç¢‘åˆ†æ”¯çº¿ï¼ˆäº¤æ›¿ä¸Šä¸‹ï¼‰ */}
    {milestones.map((m, i) => (
      <g key={m.id} transform={`translate(${x}, 0)`}>
        <line class="branch" x1="0" y1="center" x2="0" y2={i%2===0 ? top : bottom} />
        <MilestoneNode milestone={m} position={i%2===0 ? 'top' : 'bottom'} />
      </g>
    ))}

    {/* èµ·ç‚¹å’Œç»ˆç‚¹ */}
    <circle class="start" cx="0" cy="center" r="8" />
    <polygon class="end-arrow" points="..." />
  </svg>
</div>
```

ä¸ä½¿ç”¨ SVG ä¹Ÿå¯ä»¥ç”¨çº¯ CSS flexbox + absolute positioning å®ç°ï¼Œ
ä½† SVG æ›´é€‚åˆç»˜åˆ¶è¿æ¥çº¿å’ŒåŠ¨ç”»ã€‚

---

## 8. é‡Œç¨‹ç¢‘çŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  locked  â”‚  å‰ç½®é‡Œç¨‹ç¢‘æœªå®Œæˆ
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚ å‰ç½®å®Œæˆ / ç”¨æˆ·è·³è·ƒå­¦ä¹ 
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â–¶â”‚  active  â”‚  å½“å‰å¯å­¦ä¹ 
              â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚          â”‚ æ‰€æœ‰ topic è¦†ç›– / ç”¨æˆ·æ‰‹åŠ¨æ ‡è®°
              â”‚          â–¼
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     â”‚completed â”‚  å·²å®Œæˆ
              â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚          â”‚ è·¯çº¿å›¾é‡æ–°ç”Ÿæˆ
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  é‡ç½®
```

æ³¨æ„ï¼šä¸å¼ºåˆ¶çº¿æ€§é¡ºåºã€‚ç”¨æˆ·å¯ä»¥è·³è·ƒå­¦ä¹ ï¼Œä½† UI ä¸Šä¼šç”¨è§†è§‰æç¤ºï¼ˆè™šçº¿ã€åŠé€æ˜ï¼‰
æš—ç¤ºå»ºè®®çš„å­¦ä¹ é¡ºåºã€‚

---

## 9. å®æ–½ä¼˜å…ˆçº§

### Phase 1: æ ¸å¿ƒå¯è§†åŒ–ï¼ˆ1-2å¤©ï¼‰
- [ ] `FishboneTimeline` ç»„ä»¶ï¼ˆçº¯å±•ç¤ºï¼Œæ— äº¤äº’ï¼‰
- [ ] `RoadmapBar` ç´§å‡‘å¯¼èˆªæ¡
- [ ] æ›¿æ¢ SessionPage çš„ tab åˆ‡æ¢ä¸º RoadmapBar
- [ ] ç§»é™¤ Mermaid åŸå§‹ä»£ç æ˜¾ç¤º

### Phase 2: æ–‡æ¡£å…³è”ï¼ˆ1-2å¤©ï¼‰
- [ ] Document æ¨¡å‹åŠ  `roadmap_id` + `milestone_id`
- [ ] DB è¿ç§»
- [ ] `post_process` èŠ‚ç‚¹è‡ªåŠ¨å…³è”
- [ ] `content_agent` prompt æ³¨å…¥ roadmap ä¸Šä¸‹æ–‡
- [ ] æ–‡æ¡£é¡¶éƒ¨ `MilestoneBadge`

### Phase 3: è¿›åº¦è¿½è¸ªï¼ˆ1å¤©ï¼‰
- [ ] è¿›åº¦è®¡ç®—æœåŠ¡
- [ ] `GET /api/roadmaps/{id}/progress` API
- [ ] `ProgressRing` ç»„ä»¶
- [ ] é±¼éª¨å›¾è¿›åº¦å¯è§†åŒ–

### Phase 4: äº¤äº’å¢å¼ºï¼ˆ1-2å¤©ï¼‰
- [ ] ç‚¹å‡»é‡Œç¨‹ç¢‘å±•å¼€è¯¦æƒ…
- [ ] "å¼€å§‹å­¦ä¹ æœ¬é˜¶æ®µ" æŒ‰é’®
- [ ] ç‚¹å‡»çŸ¥è¯†ç‚¹è§¦å‘æ–‡æ¡£ç”Ÿæˆ
- [ ] æ‰‹åŠ¨æ ‡è®°å®Œæˆ
- [ ] æ‰‹åŠ¨è°ƒæ•´æ–‡æ¡£æ‰€å±é‡Œç¨‹ç¢‘

---

## 10. ä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

| ç°æœ‰åŠŸèƒ½ | å½±å“ | å¤„ç†æ–¹å¼ |
|----------|------|----------|
| å‚ç›´æ—¶é—´çº¿ | æ›¿æ¢ | ç”¨é±¼éª¨å›¾æ›¿ä»£ï¼Œä¿ç•™ç¼–è¾‘åŠŸèƒ½ |
| Mermaid å­—æ®µ | ä¿ç•™ä½†ä¸æ¸²æŸ“ | åç«¯ç»§ç»­ç”Ÿæˆï¼ˆå¤‡ç”¨ï¼‰ï¼Œå‰ç«¯ä¸å†æ˜¾ç¤º |
| Tab åˆ‡æ¢ | ç§»é™¤ | æ”¹ä¸º RoadmapBar å§‹ç»ˆå¯è§ |
| è·¯çº¿å›¾ç¼–è¾‘ | ä¿ç•™ | åœ¨å±•å¼€æ¨¡å¼ä¸‹æä¾›ç¼–è¾‘å…¥å£ |
| æ— è·¯çº¿å›¾çš„ä¼šè¯ | ä¸å½±å“ | RoadmapBar ä¸æ˜¾ç¤ºï¼Œå¸ƒå±€ä¸å˜ |
| å®ä½“é«˜äº® | ä¸å½±å“ | æ–‡æ¡£è§†å›¾ä¿æŒä¸å˜ |
| è·Ÿè¿›é—®é¢˜ | å¢å¼º | è·Ÿè¿›é—®é¢˜å¯å…³è”åˆ°é‡Œç¨‹ç¢‘ topic |

---

## 11. å¼€æ”¾é—®é¢˜

1. **é‡Œç¨‹ç¢‘ç²’åº¦**ï¼šå½“å‰ 4-6 ä¸ªé‡Œç¨‹ç¢‘æ˜¯å¦åˆé€‚ï¼Ÿæ˜¯å¦éœ€è¦æ”¯æŒå­é‡Œç¨‹ç¢‘ï¼Ÿ
   â†’ å»ºè®® Phase 1 ä¿æŒ 4-6 ä¸ªï¼Œåç»­æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´

2. **è·¨ä¼šè¯è·¯çº¿å›¾**ï¼šåŒä¸€å­¦ä¹ ç›®æ ‡åœ¨ä¸åŒä¼šè¯ä¸­æ˜¯å¦å…±äº«è·¯çº¿å›¾ï¼Ÿ
   â†’ å½“å‰è®¾è®¡ä¸ºä¼šè¯çº§åˆ«ï¼Œè·¨ä¼šè¯éœ€è¦ Feature 4ï¼ˆå­¦ä¹ è®°å¿†ï¼‰æ”¯æŒ

3. **å¤šè·¯çº¿å›¾å¹¶è¡Œ**ï¼šä¸€ä¸ªä¼šè¯æ˜¯å¦æ”¯æŒå¤šä¸ªè·¯çº¿å›¾ï¼Ÿ
   â†’ å½“å‰è®¾è®¡ä¸ºä¸€ä¸ªä¼šè¯ä¸€ä¸ªæ´»è·ƒè·¯çº¿å›¾ï¼Œè¶³å¤Ÿ MVP

4. **ç§»åŠ¨ç«¯é€‚é…**ï¼šæ¨ªå‘é±¼éª¨å›¾åœ¨å°å±å¹•ä¸Šå¦‚ä½•æ˜¾ç¤ºï¼Ÿ
   â†’ å°å±å¹•é™çº§ä¸ºç´§å‡‘æ¨¡å¼ï¼ˆåªæ˜¾ç¤ºèŠ‚ç‚¹æ¡ï¼‰ï¼Œå±•å¼€æ—¶å…¨å± overlay

---

## 12. è·¯çº¿å›¾åŠ¨æ€è°ƒæ•´

### 12.1 æ„å›¾è¯†åˆ«ï¼šè‡ªç„¶è¯­è¨€ä¿®æ”¹è·¯çº¿å›¾

**ç›®æ ‡**ï¼šç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€è°ƒæ•´è·¯çº¿å›¾ï¼Œè€Œéæ‰‹åŠ¨ç¼–è¾‘ JSONã€‚

**è¯†åˆ«ä½ç½®**ï¼š`backend/app/agent/classifier.py` çš„å¼ºè§„åˆ™æ¨¡å¼

âš ï¸ **æ³¨æ„**ï¼šå½“å‰ classifier.py ä¸­å·²æœ‰ `"plan"` æ„å›¾ç”¨äºç”Ÿæˆè·¯çº¿å›¾ã€‚å¯¹äºä¿®æ”¹è·¯çº¿å›¾ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**ï¼šå¤ç”¨ç°æœ‰ `"plan"` æ„å›¾
- ä¼˜ç‚¹ï¼šæ— éœ€æ–°å¢æ„å›¾ç±»å‹ï¼Œä»£ç æ”¹åŠ¨å°
- å®ç°ï¼šåœ¨ `planner_agent` å†…éƒ¨åˆ¤æ–­æ˜¯ç”Ÿæˆæ–°è·¯çº¿å›¾è¿˜æ˜¯ä¿®æ”¹ç°æœ‰è·¯çº¿å›¾

**æ–¹æ¡ˆ B**ï¼šæ–°å¢ `"modify_roadmap"` æ„å›¾
- ä¼˜ç‚¹ï¼šæ„å›¾æ›´æ˜ç¡®ï¼Œä¾¿äºåç»­æ‰©å±•
- ç¼ºç‚¹ï¼šéœ€è¦ä¿®æ”¹å¤šå¤„ä»£ç 

ä»¥ä¸‹æŒ‰æ–¹æ¡ˆ B å±•ç¤ºï¼ˆå¦‚é‡‡ç”¨æ–¹æ¡ˆ Aï¼Œå¯è·³è¿‡æœ¬èŠ‚ï¼‰ï¼š

```python
# åœ¨ STRONG_PATTERNS ä¸­æ–°å¢ï¼ˆä¸ç°æœ‰ plan æ¨¡å¼åŒºåˆ†ï¼‰
self.STRONG_PATTERNS = {
    # ... ç°æœ‰æ¨¡å¼ ...

    # roadmap ç”Ÿæˆï¼ˆç°æœ‰ï¼‰
    r"å­¦ä¹ è·¯å¾„|å­¦ä¹ å»ºè®®|å­¦ä¹ è§„åˆ’|è·¯çº¿å›¾|roadmap|plan|è§„åˆ’.*å­¦ä¹ ": ("plan", 1.0),

    # roadmap ä¿®æ”¹ï¼ˆæ–°å¢ï¼‰- æ›´å…·ä½“çš„åŒ¹é…è§„åˆ™
    r"æŠŠ.*å’Œ.*åˆå¹¶|åˆå¹¶.*é˜¶æ®µ": ("modify_roadmap", 1.0),
    r"åœ¨.*åé¢æ’å…¥|å¢åŠ .*é˜¶æ®µ|æ·»åŠ .*é˜¶æ®µ": ("modify_roadmap", 1.0),
    r"åˆ é™¤.*é˜¶æ®µ|ç§»é™¤.*é˜¶æ®µ": ("modify_roadmap", 1.0),
    r"æŠŠ.*æå‰|æŠŠ.*æŒªåˆ°.*åé¢|è°ƒæ•´.*é¡ºåº|é‡æ’.*": ("modify_roadmap", 1.0),
    r"å¤ªç®€å•äº†|å¤ªåŸºç¡€äº†|è·³è¿‡.*|å¤ªéš¾äº†": ("modify_roadmap", 1.0),
}
```

**è·¯ç”±æ‰©å±•**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®é™…ä»£ç æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

intent_agent
    â”‚
    â”œâ”€ chitchat â†’ chitchat_agent
    â”œâ”€ navigate â†’ navigator_agent
    â”‚
    â””â”€ [å…¶ä»–æ„å›¾] â†’ route_agent
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ route_agent   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
    navigate       plan       modify_roadmap
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
  navigator_   planner_     planner_agent
     agent       agent       (modify mode)
                      â”‚             â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                      planner_agent
                      (generate mode)
                             â”‚
                             â–¼
                      content_agent
```

âš ï¸ **å…³é”®å˜æ›´**ï¼š`modify_roadmap` æ„å›¾éœ€è¦å…ˆç»è¿‡ `route_agent`ï¼Œå†è·¯ç”±åˆ° `planner_agent`ã€‚

---

### 12.2 Planner Agent æ‰©å±•ï¼šæ”¯æŒä¿®æ”¹æ¨¡å¼

**å½“å‰çŠ¶æ€**ï¼š`planner_agent` åªæ”¯æŒ"ä»é›¶ç”Ÿæˆ"æ¨¡å¼ã€‚

**æ‰©å±•æ–¹æ¡ˆ**ï¼šæ·»åŠ "ä¿®æ”¹æ¨¡å¼"ï¼Œå¤ç”¨ç°æœ‰èŠ‚ç‚¹ã€‚

```python
# backend/app/agent/nodes/planner.py

async def planner_agent_node(state: AgentState) -> AgentState:
    """Generate or modify learning roadmap."""
    intent = state.get("intent", {})
    user_level = state.get("user_level", "beginner")

    # === ä¿®æ”¹æ¨¡å¼ï¼ˆNEWï¼‰===
    if intent.get("intent_type") == "modify_roadmap":
        return await _modify_roadmap(state, user_level)

    # === ç”Ÿæˆæ¨¡å¼ï¼ˆç°æœ‰ï¼‰===
    return await _generate_roadmap(state, user_level)


async def _modify_roadmap(state: AgentState, user_level: str) -> AgentState:
    """Modify existing roadmap based on user request."""
    current_roadmap = state.get("current_roadmap")  # ä»ä¼šè¯çŠ¶æ€è·å–
    modify_instruction = state.get("raw_message", "")
    llm = get_llm()

    structured_llm = llm.with_structured_output(RoadmapOutput)

    result = await structured_llm.ainvoke([
        SystemMessage(content="""
ä½ æ˜¯å­¦ä¹ è·¯å¾„è§„åˆ’ä¸“å®¶ã€‚ç”¨æˆ·è¦ä¿®æ”¹ç°æœ‰è·¯çº¿å›¾ï¼Œè¯·æ ¹æ®è¦æ±‚è°ƒæ•´ã€‚

ä¿®æ”¹è§„åˆ™ï¼š
- åˆå¹¶é˜¶æ®µï¼šå°†å¤šä¸ªé˜¶æ®µåˆå¹¶ä¸ºä¸€ä¸ªï¼Œä¿ç•™æ‰€æœ‰ topics
- æ’å…¥é˜¶æ®µï¼šåœ¨æŒ‡å®šä½ç½®åæ·»åŠ æ–°é˜¶æ®µï¼Œè°ƒæ•´åç»­ ID
- åˆ é™¤é˜¶æ®µï¼šç§»é™¤æŒ‡å®šé˜¶æ®µï¼Œé‡æ–°æ’åˆ— ID
- è°ƒæ•´é¡ºåºï¼šæŒ‰ç”¨æˆ·è¦æ±‚é‡æ’é˜¶æ®µï¼Œä¿æŒ ID è¿ç»­
- é™çº§/å‡çº§ï¼šè°ƒæ•´ topics éš¾åº¦ï¼Œä¿æŒé˜¶æ®µæ•°é‡ä¸å˜

è¿”å›è°ƒæ•´åçš„å®Œæ•´è·¯çº¿å›¾ JSONã€‚
        """),
        HumanMessage(content=f"""
å½“å‰è·¯çº¿å›¾ï¼š
{json.dumps(current_roadmap, ensure_ascii=False, indent=2)}

ç”¨æˆ·ä¿®æ”¹è¦æ±‚ï¼š{modify_instruction}

è¯·è¿”å›ä¿®æ”¹åçš„è·¯çº¿å›¾ã€‚
        """),
    ])

    roadmap = {
        "goal": result.goal,
        "milestones": [m.model_dump() for m in result.milestones],
        "mermaid": result.mermaid,
        "version": current_roadmap.get("version", 1) + 1,  # ç‰ˆæœ¬é€’å¢
    }

    state["roadmap"] = roadmap
    return state
```

**çŠ¶æ€å­—æ®µæ‰©å±•**ï¼š

```python
# backend/app/agent/state.py

from typing import Annotated

class AgentState(TypedDict):
    # ... ç°æœ‰å­—æ®µ ...

    # NEW: è·¯çº¿å›¾ç›¸å…³ï¼ˆéµå¾ªç°æœ‰ä»£ç é£æ ¼ï¼Œä½¿ç”¨ Annotatedï¼‰
    current_roadmap: Annotated[dict | None, "å½“å‰æ´»è·ƒè·¯çº¿å›¾"]
    roadmap_modified: Annotated[bool, "è·¯çº¿å›¾æ˜¯å¦è¢«ä¿®æ”¹è¿‡"]
    roadmap_only: Annotated[bool, "æ˜¯å¦ä»…ç”Ÿæˆè·¯çº¿å›¾è€Œä¸ç”Ÿæˆæ–‡æ¡£"]  # ç”¨äºæ¡ä»¶è·¯ç”±
```

---

### 12.3 ä¿®æ”¹åçš„æ–‡æ¡£é‡æ˜ å°„ç­–ç•¥

**æ ¸å¿ƒåŸåˆ™**ï¼š**æ–‡æ¡£å†…å®¹ä¸å˜ï¼Œåªæ›´æ–°å…³è”å…³ç³»**ã€‚

è·¯çº¿å›¾ä¿®æ”¹åï¼Œå·²æœ‰æ–‡æ¡£çš„ `milestone_id` å¯èƒ½å¤±æ•ˆï¼Œä½†ï¼š
- âœ… æ–‡æ¡£å†…å®¹å®Œå…¨ä¿ç•™
- âœ… åªæ›´æ–° `milestone_id` å­—æ®µ
- âœ… æ— æ³•åŒ¹é…çš„æ–‡æ¡£æ ‡è®°ä¸º"å­¤å„¿"ï¼Œä½†ç”¨æˆ·ä»å¯æŸ¥çœ‹

**åœºæ™¯åˆ†æ**ï¼š

| ä¿®æ”¹æ“ä½œ | å½±å“ | å¤„ç†ç­–ç•¥ |
|----------|------|----------|
| æ–°å¢é‡Œç¨‹ç¢‘ | æ— å½±å“ | æ–°é‡Œç¨‹ç¢‘æ— æ–‡æ¡£ï¼Œè‡ªç„¶ç´¯ç§¯ |
| åˆ é™¤é‡Œç¨‹ç¢‘ | å­¤å„¿æ–‡æ¡£ | è§¦å‘é‡æ˜ å°„ â†’ `_remap_documents_after_modify()` |
| ä¿®æ”¹ topics | æ˜ å°„å¯èƒ½è¿‡æ—¶ | è§¦å‘é‡æ˜ å°„ |
| é‡æ’é¡ºåº | ID ä¸å˜åˆ™æ— å½±å“ | milestone.id ä¿æŒç¨³å®šï¼Œæ— éœ€é‡æ˜ å°„ |
| åˆå¹¶é‡Œç¨‹ç¢‘ | æ–‡æ¡£éœ€åˆå¹¶å½’å± | è§¦å‘é‡æ˜ å°„ |
| é™çº§/å‡çº§ | topics å˜åŒ– | è§¦å‘é‡æ˜ å°„ |

**é‡æ˜ å°„æµç¨‹**ï¼š

**é‡æ˜ å°„æµç¨‹**ï¼š

```python
# backend/app/services/roadmap_service.py

async def _remap_documents_after_modify(
    db: AsyncSession,
    session_id: str,
    old_roadmap: dict,
    new_roadmap: dict,
):
    """è·¯çº¿å›¾ä¿®æ”¹åï¼Œé‡æ˜ å°„æ‰€æœ‰å…³è”æ–‡æ¡£ã€‚

    æ ¸å¿ƒåŸåˆ™ï¼š
    - æ–‡æ¡£å†…å®¹å®Œå…¨ä¸å˜
    - åªæ›´æ–° milestone_id å­—æ®µ
    - æ— æ³•åŒ¹é…çš„æ–‡æ¡£æ ‡è®°ä¸ºå­¤å„¿ï¼ˆmilestone_id = NULLï¼‰ï¼Œä½†ä¿ç•™å†…å®¹
    """
    old_milestones = {m["id"]: m["title"] for m in old_roadmap["milestones"]}
    new_milestones = new_roadmap["milestones"]

    # è·å–æ‰€æœ‰å…³è”æ–‡æ¡£
    documents = await _get_roadmap_documents(db, session_id, old_roadmap["id"])

    remap_results = []
    orphans = []

    for doc in documents:
        old_mid = doc.get("milestone_id")
        doc_id = doc["id"]

        # ç­–ç•¥ 1: å¦‚æœæ—§ milestone ID ä»å­˜åœ¨ï¼Œä¿æŒä¸å˜
        if any(m["id"] == old_mid for m in new_milestones):
            continue

        # ç­–ç•¥ 2: å°è¯•åŸºäºå†…å®¹é‡æ–°åˆ†ç±»
        new_mid = await _classify_milestone_for_remap(
            doc["topic"],
            doc["content"][:500],
            new_milestones,
        )

        # ç­–ç•¥ 3: å¦‚æœæ— æ³•åŒ¹é…ï¼Œæ ‡è®°ä¸ºå­¤å„¿ï¼ˆæ–‡æ¡£ä¿ç•™ï¼Œmilestone_id = NULLï¼‰
        if new_mid is None:
            orphans.append({
                "doc_id": doc_id,
                "old_mid": old_mid,
                "old_title": old_milestones.get(old_mid, "æœªçŸ¥"),
                "orphan_reason": f"åŸé‡Œç¨‹ç¢‘ã€Œ{old_milestones.get(old_mid)}ã€å·²åˆ é™¤ï¼Œæ— æ³•è‡ªåŠ¨åŒ¹é…åˆ°æ–°é‡Œç¨‹ç¢‘",
            })
            # æ›´æ–°ä¸ºå­¤å„¿çŠ¶æ€
            await _update_document_milestone(
                db, doc_id, milestone_id=None, orphan_reason=orphans[-1]["orphan_reason"]
            )
        else:
            # æ›´æ–°åˆ°æ–°é‡Œç¨‹ç¢‘
            await _update_document_milestone(db, doc_id, milestone_id=new_mid)
            remap_results.append({
                "doc_id": doc_id,
                "old_mid": old_mid,
                "new_mid": new_mid,
            })

    return {
        "remapped": remap_results,
        "orphans": orphans,  # å­¤å„¿æ–‡æ¡£åˆ—è¡¨ï¼Œç”¨äºå‰ç«¯æç¤º
    }
```

**è§¦å‘æ—¶æœº**ï¼š`planner_agent` è¿”å›ä¿®æ”¹åçš„è·¯çº¿å›¾æ—¶ï¼Œæ‰§è¡Œé‡æ˜ å°„ã€‚

âš ï¸ **é‡è¦**ï¼šåœ¨ LangGraph èŠ‚ç‚¹ä¸­ä½¿ç”¨ `asyncio.create_task` åˆ›å»ºçš„åå°ä»»åŠ¡ä¸ä¼šè¢« LangGraph çš„æ£€æŸ¥ç‚¹æœºåˆ¶è¿½è¸ªã€‚å¦‚æœè¿›ç¨‹åœ¨é‡æ˜ å°„å®Œæˆå‰å´©æºƒï¼Œä¼šå¯¼è‡´æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ã€‚

**æ–¹æ¡ˆé€‰æ‹©**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| åŒæ­¥é‡æ˜ å°„ | ç®€å•ã€å¯é ã€çŠ¶æ€ä¸€è‡´ | ç”¨æˆ·éœ€ç­‰å¾… | â­â­â­â­ |
| Celery ä»»åŠ¡é˜Ÿåˆ— | å¼‚æ­¥ã€å¯è¿½è¸ª | éœ€è¦é¢å¤–ä¾èµ– | â­â­â­ |
| asyncio.create_task | ç®€å• | çŠ¶æ€ä¸ä¸€è‡´é£é™© | â­ |

**æ¨èæ–¹æ¡ˆ**ï¼šåŒæ­¥é‡æ˜ å°„ï¼ˆé‡æ˜ å°„é€šå¸¸å¾ˆå¿«ï¼Œ< 1ç§’ï¼‰

```python
# planner_agent_node è¿”å›å‰
if intent.get("intent_type") == "modify_roadmap":
    # åŒæ­¥æ‰§è¡Œé‡æ˜ å°„ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
    remap_result = await _remap_documents_after_modify(
        db, state["session_id"],
        state.get("current_roadmap"),
        roadmap,
    )

    # è¿”å›ç»“æœä¸­åŒ…å«é‡æ˜ å°„ç»“æœ
    state["remap_result"] = remap_result
```

---

### 12.3.1 å­¤å„¿æ–‡æ¡£çš„å¤„ç†

å½“æ–‡æ¡£æ— æ³•åŒ¹é…åˆ°æ–°é‡Œç¨‹ç¢‘æ—¶ï¼Œæ ‡è®°ä¸ºå­¤å„¿çŠ¶æ€ï¼Œä½†**æ–‡æ¡£å†…å®¹å®Œå…¨ä¿ç•™**ã€‚

**æ•°æ®åº“å­—æ®µ**ï¼š

```python
# Document æ¨¡å‹æ–°å¢å­—æ®µ
milestone_id: int | None = None           # å…³è”çš„é‡Œç¨‹ç¢‘ IDï¼ˆå­¤å„¿ä¸º NULLï¼‰
roadmap_id: int | None = None             # å…³è”çš„è·¯çº¿å›¾ ID
orphan_reason: str | None = None          # å­¤å„¿åŸå› ï¼ˆå¦‚æœ milestone_id ä¸º NULLï¼‰
```

**å‰ç«¯å±•ç¤º**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ React æ€§èƒ½ä¼˜åŒ–                        â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ âš ï¸ æ­¤æ–‡æ¡£ä¸åœ¨å½“å‰è·¯çº¿å›¾ä¸­                 â”‚
â”‚                                         â”‚
â”‚ åŸå› ï¼šæ‰€å±çš„ã€Œæ€§èƒ½ä¼˜åŒ–ã€é˜¶æ®µå·²è¢«åˆ é™¤       â”‚
â”‚                                         â”‚
â”‚ [æ‰‹åŠ¨å…³è”åˆ°é‡Œç¨‹ç¢‘]  [ä¿æŒç‹¬ç«‹æ–‡æ¡£]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡» [æ‰‹åŠ¨å…³è”åˆ°é‡Œç¨‹ç¢‘] â†’ å¼¹å‡ºé‡Œç¨‹ç¢‘é€‰æ‹©å™¨
ç‚¹å‡» [ä¿æŒç‹¬ç«‹æ–‡æ¡£] â†’ å…³é—­æç¤ºï¼Œæ–‡æ¡£å¯æ­£å¸¸æŸ¥çœ‹
```

**API**ï¼š

```python
# ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´æ–‡æ¡£å…³è”
PATCH /api/documents/{doc_id}/milestone
{
  "milestone_id": 2,  # ç”¨æˆ·é€‰æ‹©çš„æ–°é‡Œç¨‹ç¢‘ï¼Œæˆ– nullï¼ˆä¿æŒç‹¬ç«‹ï¼‰
  "orphan_reason": null  # æ¸…é™¤å­¤å„¿æ ‡è®°
}
```

---

### 12.4 Agent æµç¨‹æ›´æ–°

âš ï¸ **æ¶æ„å˜æ›´**ï¼šå½“å‰ä»£ç ï¼ˆ`graph.py` ç¬¬ 78 è¡Œï¼‰ä¸­ï¼Œ`planner_agent` æ€»æ˜¯ä¼šè¿›å…¥ `content_agent`ï¼š

```python
workflow.add_edge("planner_agent", "content_agent")
```

è¦å®ç°"ä¿®æ”¹è·¯çº¿å›¾åç›´æ¥è¿”å›"çš„åŠŸèƒ½ï¼Œéœ€è¦**æ·»åŠ æ¡ä»¶è¾¹**ï¼š

```python
# backend/app/agent/graph.py

workflow.add_conditional_edges(
    "planner_agent",
    lambda state: "END" if state.get("roadmap_only") else "content_agent",
    {"END": END, "content_agent": "content_agent"},
)
```

ç„¶ååœ¨ `planner_agent_node` ä¸­è®¾ç½®çŠ¶æ€æ ‡å¿—ï¼š

```python
if intent.get("intent_type") == "modify_roadmap":
    # ... ä¿®æ”¹è·¯çº¿å›¾é€»è¾‘ ...
    state["roadmap_only"] = True  # ä¿®æ”¹åç›´æ¥è¿”å›
else:
    state["roadmap_only"] = False  # ç”Ÿæˆåç»§ç»­ç”Ÿæˆæ–‡æ¡£
```

**æ›´æ–°åçš„å®Œæ•´æµç¨‹**ï¼š

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  ç”¨æˆ·è¾“å…¥        â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Intent Agent    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚        â”‚          â”‚          â”‚
    new_topic  chitchat  modify_roadmap  navigate  ...
         â”‚          â”‚        â”‚          â”‚
         â–¼          â–¼        â–¼          â–¼
    route_     chitchat  planner_   navigator
    agent       agent     agent       agent
         â”‚                   â”‚
         â”‚                   â–¼
         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚ æ¡ä»¶è·¯ç”±      â”‚
         â”‚            â”‚ (modeåˆ¤æ–­)    â”‚
         â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           generate  modify
         â”‚               â”‚      â”‚
         â”‚               â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚                    â”‚
         â”‚               â–¼                    â–¼
         â”‚          content_             END (è¿”å›æ–°è·¯çº¿å›¾)
         â”‚          agent                (ä¸ç”Ÿæˆæ–‡æ¡£)
         â”‚               â”‚
         â”‚               â–¼
         â”‚         post_process (å¹¶è¡Œ)
         â”‚               â”‚
         â”‚            â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚                 â”‚
         â”‚         entities      follow_ups  milestone_classify (NEW)
         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ content_agent (generate)
                              â”‚
                              â–¼
                        post_process (å¹¶è¡Œ)
                              â”‚
                           â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚                 â”‚
                       entities      follow_ups  milestone_classify (NEW)
```

**å…³é”®ç‚¹**ï¼š

1. **modify_roadmap â†’ planner_agent â†’ END**
   - ä¿®æ”¹è·¯çº¿å›¾åç›´æ¥è¿”å›æ–°è·¯çº¿å›¾ç»™ç”¨æˆ·
   - **ä¸ç”Ÿæˆæ–°æ–‡æ¡£**
   - **ä¸åˆ é™¤æ—§æ–‡æ¡£**

2. **å¼‚æ­¥é‡æ˜ å°„**
   - planner_agent è¿”å›æ—¶è§¦å‘å¼‚æ­¥ä»»åŠ¡ `_remap_documents_after_modify()`
   - åœ¨åå°é‡æ–°å…³è”æ‰€æœ‰æ–‡æ¡£åˆ°æ–°é‡Œç¨‹ç¢‘
   - æ–‡æ¡£å†…å®¹ä¸å˜ï¼Œåªæ›´æ–° `milestone_id`

3. **é¦–æ¬¡ç”Ÿæˆè·¯çº¿å›¾**
   - planner_agent (generate_mode) â†’ content_agent â†’ post_process
   - ç”Ÿæˆè·¯çº¿å›¾åï¼Œè‡ªåŠ¨ç”Ÿæˆç¬¬ä¸€ä¸ªé˜¶æ®µçš„æ–‡æ¡£

---

### 12.5 æ‰‹åŠ¨è°ƒæ•´ï¼ˆè¡¥å……ï¼‰

é™¤äº†è‡ªåŠ¨å…³è”ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨ UI ä¸Šæ‰‹åŠ¨è°ƒæ•´ï¼š

**ä½ç½®**ï¼šæ–‡æ¡£é¡¶éƒ¨çš„ MilestoneBadge ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ React Hooks æ·±å…¥è§£æ              â”‚
â”‚ ğŸ“ é˜¶æ®µ4 Â· Hooks & é«˜çº§æ¨¡å¼  [â–¼]     â”‚  â† ç‚¹å‡»åˆ‡æ¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ (æ–‡æ¡£å†…å®¹...)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API**ï¼š
```python
PATCH /api/documents/{id}
{
  "milestone_id": 2,  # ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©çš„æ–°é‡Œç¨‹ç¢‘
}
```

**æ³¨æ„**ï¼šæ‰‹åŠ¨è°ƒæ•´ä¸ä¼šè§¦å‘è·¯çº¿å›¾çº§åˆ«çš„é‡æ˜ å°„ï¼Œä»…å½±å“å•ä¸ªæ–‡æ¡£ã€‚

---

## 13. è®¾è®¡è¯„å®¡è®°å½•

### 2025-02-16 è¯„å®¡ - æ–¹æ¡ˆ C é€‰æ‹©

æœ¬æ¬¡è¯„å®¡çš„æ ¸å¿ƒå†³ç­–ï¼š**é€‰æ‹©æ–¹æ¡ˆ Cï¼ˆå¢å¼º route_agentï¼‰ä½œä¸º Agentic è·¯ç”±å†³ç­–çš„å®ç°æ–¹æ¡ˆ**ã€‚

**å†³ç­–è¿‡ç¨‹**ï¼š

1. **é—®é¢˜æå‡º**ï¼šå½“å‰çš„è·¯ç”±å†³ç­–ä½¿ç”¨ç®€å•è§„åˆ™åŒ¹é…ï¼Œä¸å¤Ÿ Agentic
2. **æ–¹æ¡ˆå¯¹æ¯”**ï¼š
   - æ–¹æ¡ˆ Aï¼šå¢å¼º intent_agentï¼ˆæ„å›¾+å†³ç­–åˆå¹¶ï¼‰
   - æ–¹æ¡ˆ Bï¼šç‹¬ç«‹ decision_agentï¼ˆæ–°å¢èŠ‚ç‚¹ï¼‰
   - æ–¹æ¡ˆ Cï¼šå¢å¼º route_agentï¼ˆåœ¨ç°æœ‰èŠ‚ç‚¹å†…å¢å¼ºï¼‰

3. **æœ€ç»ˆé€‰æ‹©**ï¼šæ–¹æ¡ˆ C

**é€‰æ‹©ç†ç”±**ï¼š

| è¯„ä»·ç»´åº¦ | æ–¹æ¡ˆ A | æ–¹æ¡ˆ B | æ–¹æ¡ˆ C (é€‰ä¸­) |
|---------|-------|-------|--------------|
| èŒè´£æ¸…æ™° | âš ï¸ | âœ… | âœ… |
| å›¾ç»“æ„å˜æ›´ | æ—  | +1 èŠ‚ç‚¹ | æ—  |
| ç¬¦åˆå‘½åç›´è§‰ | âš ï¸ | âœ… | âœ… |
| ç¬¦åˆ LangGraph æƒ¯ä¾‹ | âš ï¸ | âœ… | âœ… |
| å®ç°å¤æ‚åº¦ | ä¸­ | é«˜ | ä¸­ |
| æ¸è¿›å¼æ¼”è¿› | âš ï¸ | âœ… | âœ… |

**æ–¹æ¡ˆ C æ ¸å¿ƒç‰¹ç‚¹**ï¼š

```
route_agent ä»"è§„åˆ™åŒ¹é…å™¨"å‡çº§ä¸º"æ™ºèƒ½å†³ç­– Agent"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      route_agent                            â”‚
â”‚                    â•â•â•â•â• æ··åˆç­–ç•¥ â•â•â•â•â•                     â”‚
â”‚                                                             â”‚
â”‚  ã€å¿«é€Ÿè·¯å¾„ã€‘æ˜æ˜¾æƒ…å†µ â†’ è§„åˆ™åŒ¹é… (< 1ms)                    â”‚
â”‚  ã€æ™ºèƒ½è·¯å¾„ã€‘å¤æ‚æƒ…å†µ â†’ LLM æ¨ç† (~500ms)                   â”‚
â”‚                                                             â”‚
â”‚  è¾“å‡º: routing_decision + reasoning (å¯è§£é‡Š)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ–½è¦ç‚¹**ï¼š

1. ä¿æŒå›¾ç»“æ„ä¸å˜ï¼Œæ— éœ€ä¿®æ”¹ `graph.py`
2. ä¸»è¦æ”¹åŠ¨æ–‡ä»¶ï¼š`backend/app/agent/nodes/route.py`
3. æ–°å¢çŠ¶æ€å­—æ®µï¼š`current_roadmap`, `roadmap_only` ç­‰
4. æ”¯æŒ fallback æœºåˆ¶ï¼ˆLLM å¤±è´¥æ—¶é™çº§åˆ°è§„åˆ™ï¼‰
5. è¾“å‡º reasoning ä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–

### 2025-02-16 åˆæ¬¡è¯„å®¡

æœ¬æ¬¡è¯„å®¡å‘ç°å¹¶ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

| # | é—®é¢˜æè¿° | ä¿®å¤æ–¹å¼ |
|---|---------|---------|
| 1 | æ•°æ®æ¨¡å‹æè¿°ä¸å¤Ÿæ˜ç¡®ï¼Œæœªè¯´æ˜æ˜¯"éœ€è¦æ–°å¢"çš„å­—æ®µ | æ·»åŠ  âš ï¸ è­¦å‘Šæ ‡æ³¨ï¼Œæ˜ç¡®è¯´æ˜å½“å‰æ¨¡å‹ä¸­ä¸å­˜åœ¨ |
| 2 | ä»£ç ç¤ºä¾‹åŒæ—¶å±•ç¤º"å½“å‰"å’Œ"æ‰©å±•å"ï¼Œå®¹æ˜“è¯¯è§£ | æ”¹ç”¨ "ä¿®æ”¹å‰/ä¿®æ”¹å" å¯¹æ¯”æ ¼å¼ |
| 3 | æ„å›¾åˆ†ç±»å™¨æ–°å¢æ„å›¾ä¸ç°æœ‰ plan æ„å›¾å…³ç³»ä¸æ˜ç¡® | æ·»åŠ æ–¹æ¡ˆ A/B å¯¹æ¯”ï¼Œè¯´æ˜å¤ç”¨ç°æœ‰æ„å›¾çš„é€‰é¡¹ |
| 4 | è·¯ç”±æµç¨‹å›¾é—æ¼ route_agent èŠ‚ç‚¹ | é‡ç»˜æµç¨‹å›¾ï¼Œå±•ç¤ºå®Œæ•´çš„ intent â†’ route â†’ planner é“¾è·¯ |
| 5 | çŠ¶æ€å­—æ®µæœªéµå¾ªç°æœ‰ä»£ç é£æ ¼ï¼ˆAnnotatedï¼‰ | æ›´æ–°ä¸ºä½¿ç”¨ Annotated ç±»å‹ |
| 6 | å¼‚æ­¥ä»»åŠ¡æœ‰çŠ¶æ€ä¸ä¸€è‡´é£é™© | æ·»åŠ æ–¹æ¡ˆå¯¹æ¯”ï¼Œæ¨èåŒæ­¥é‡æ˜ å°„ |
| 7 | ç¼ºå°‘ planner_agent æ¡ä»¶è¾¹çš„æ¶æ„å˜æ›´è¯´æ˜ | æ·»åŠ æ˜ç¡®çš„ä»£ç ç¤ºä¾‹å’Œæ¶æ„å˜æ›´è¯´æ˜ |
| 8 | "é¦–æ¬¡ç”Ÿæˆè·¯çº¿å›¾"æµç¨‹ç¼ºå°‘å†³ç­–é€»è¾‘ | æ·»åŠ å†³ç­–æ ‘ï¼Œè¯´æ˜ä½•æ—¶ç”Ÿæˆè·¯çº¿å›¾ vs ç›´æ¥ç”Ÿæˆæ–‡æ¡£ |

### å¼€æ”¾é—®é¢˜ï¼ˆå¾…è®¨è®ºï¼‰

1. **æ„å›¾å¤ç”¨ vs æ–°å¢**ï¼š
   - å½“å‰é€‰æ‹©ï¼šåœ¨ route_agent ä¸­é€šè¿‡ LLM åˆ¤æ–­æ˜¯ç”Ÿæˆè¿˜æ˜¯ä¿®æ”¹
   - å¤‡é€‰æ–¹æ¡ˆï¼šæ–°å¢ `modify_roadmap` æ„å›¾ç±»å‹ï¼ˆéœ€è¦ä¿®æ”¹ classifier.pyï¼‰
   - å¾…å®šï¼šå“ªç§æ–¹å¼æ›´åˆ©äºåç»­æ‰©å±•ï¼Ÿ

2. **é‡æ˜ å°„ç­–ç•¥**ï¼š
   - milestone.id åœ¨"é‡æ’é¡ºåº"æ—¶æ˜¯å¦ä¿æŒç¨³å®šï¼Ÿ
   - å¦‚ä½•ä¿è¯é‡æ˜ å°„åæ–‡æ¡£èƒ½æ­£ç¡®å…³è”ï¼Ÿ

3. **LLM æ¨¡å‹é€‰æ‹©**ï¼š
   - å½“å‰ä½¿ç”¨ `gpt-4o-mini` è¿›è¡Œè·¯ç”±å†³ç­–
   - æ˜¯å¦éœ€è¦é’ˆå¯¹è·¯ç”±å†³ç­–å¾®è°ƒ promptï¼Ÿ
   - æ˜¯å¦éœ€è¦æ”¶é›†å†³ç­–æ•°æ®ç”¨äºè¯„ä¼°å’Œä¼˜åŒ–ï¼Ÿ

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å½“å‰çº¦ 30-40% çš„è¯·æ±‚èµ° LLM è·¯å¾„
   - æ˜¯å¦éœ€è¦å¢åŠ æ›´å¤šè§„åˆ™ä»¥å‡å°‘ LLM è°ƒç”¨ï¼Ÿ
   - æ˜¯å¦éœ€è¦ç¼“å­˜å¸¸è§å†³ç­–æ¨¡å¼ï¼Ÿ
